<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Vocabulary Builder</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Noto Sans KR font global application */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #e0e5ec; /* Neumorphism background */
            color: #4a5568; /* Default text color */
        }

        /* --- Global 3D Text Effect (Neumorphic Texture) --- */
        body, h1, h2, h3, h4, p, span, div, button, a {
            text-shadow: 1px 1px 1px #ffffff, -1px -1px 1px #c5c9d2;
        }
        input, select, textarea {
            text-shadow: none;
            background-color: #e0e5ec;
        }
        .prose p, .prose li {
            text-shadow: none;
        }
        /* --- END --- */

        /* 3D texture (embossed effect) button style */
        .btn-3d {
            background-color: #e0e5ec;
            border: none;
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 600;
            color: #4a5568;
            box-shadow: 6px 6px 12px #c5c9d2, -6px -6px 12px #fdffff;
            transition: all 0.2s ease-in-out;
            outline: none;
            text-shadow: 1px 1px 1px #ffffff, -1px -1px 1px #c5c9d2;
            cursor: pointer;
        }

        .btn-3d:hover {
            box-shadow: 4px 4px 8px #c5c9d2, -4px -4px 8px #fdffff;
            transform: translateY(-1px);
        }

        .btn-3d:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: inset 2px 2px 4px #c5c9d2, inset -2px -2px 4px #fdffff;
            transform: none;
        }

        .btn-3d:active {
            box-shadow: inset 4px 4px 8px #c5c9d2, inset -4px -4px 8px #fdffff;
        }

        /* Card design */
        .card {
            background-color: #e0e5ec;
            border-radius: 15px;
            box-shadow: 8px 8px 16px #c5c9d2, -8px -8px 16px #fdffff;
            margin-bottom: 2rem;
        }

        /* Click to Search style */
        .clickable-word {
            cursor: pointer;
            font-weight: 500;
            color: #2b6cb0;
            transition: color 0.2s;
            border-bottom: 1px dotted #2b6cb0;
            text-shadow: none;
        }
        .clickable-word:hover {
            color: #2c5282;
            background-color: #bee3f8;
        }

        /* Loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Modal style */
        .modal {
            transition: opacity 0.3s ease;
        }

        /* Toast message style */
        .toast {
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.5s, visibility 0.5s, bottom 0.5s;
            z-index: 9999;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }

        .clickable-image {
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
        }
        .clickable-image:hover {
            transform: scale(1.02);
        }

        /* Icon Button Base Style (Circular Neumorphism) */
        .icon-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            background-color: #e2e8f0;
            transition: all 0.2s;
            color: #4a5568;
            box-shadow: 3px 3px 6px #c5c9d2, -3px -3px 6px #fdffff;
            position: relative;
            border: none;
            cursor: pointer;
        }
        .icon-btn:hover {
            color: #1a202c;
            box-shadow: 2px 2px 4px #c5c9d2, -2px -2px 4px #fdffff;
        }
        .icon-btn:active {
            box-shadow: inset 2px 2px 4px #c5c9d2, inset -2px -2px 4px #fdffff;
        }

        .icon-btn svg {
            filter: drop-shadow(1px 1px 1px rgba(255, 255, 255, 0.7)) drop-shadow(-1px -1px 1px rgba(0, 0, 0, 0.2));
            transition: filter 0.2s;
        }

        /* Tooltip styles */
        .tooltip {
            visibility: hidden;
            opacity: 0;
            background-color: #2d3748;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            transition: opacity 0.2s;
            white-space: nowrap;
            font-size: 0.75rem;
            text-shadow: none;
            pointer-events: none;
        }

        .icon-btn:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* Print-specific styles */
        @media print {
            body {
                background-color: #fff !important;
                font-family: 'Times New Roman', serif;
                margin: 0;
                padding: 0;
            }
            #app-container, #search-bar-container, #shortcut-buttons, #loading-container,
            #tab-bar, footer, .modal, .toast, .tooltip, #auth-container, #confirmation-modal, #password-modal,
            #google-calendar {
                display: none !important;
            }
            #print-container {
                display: block !important;
                width: 100%;
                margin: 0 auto;
                padding: 0 1cm;
            }
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 20px;
                padding-top: 10px;
            }
            .print-header h1 {
                font-size: 24pt;
                font-weight: bold;
                color: #000;
                text-shadow: none;
            }
            .card {
                box-shadow: none;
                border: 1px solid #ccc;
                background-color: #fff !important;
                margin-bottom: 1.5rem;
                padding: 10px !important;
                break-inside: avoid;
            }
            img {
                max-width: 100%;
                height: auto;
                break-inside: avoid;
            }
            #print-container * {
                text-shadow: none !important;
            }
            .btn-3d, .icon-btn, #pronunciation-btn {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-slate-100 text-gray-800">

    <div id="auth-container" class="fixed inset-0 bg-slate-100 z-[100] flex items-center justify-center hidden">
        <div class="card p-8 text-center max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold mb-4">로그인</h2>
            <p class="mb-6 text-gray-600">모든 기능을 사용하려면 Google 계정으로 로그인하세요.</p>
            <button id="google-login-btn" class="btn-3d !bg-blue-500 !text-white hover:!bg-blue-600 flex items-center justify-center w-full mb-4">
                <svg class="w-5 h-5 mr-2" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><defs><path id="a" d="M44.5 20H24v8.5h11.8C34.7 33.9 30.1 37 24 37c-7.2 0-13-5.8-13-13s5.8-13 13-13c3.1 0 5.9 1.1 8.1 2.9l6.4-6.4C34.6 4.1 29.6 2 24 2 11.8 2 2 11.8 2 24s9.8 22 22 22c11 0 21-8 21-22 0-1.3-.2-2.7-.5-4z"/></defs><clipPath id="b"><use xlink:href="#a" overflow="visible"/></clipPath><path clip-path="url(#b)" fill="#FBBC05" d="M0 37V11l17 13z"/><path clip-path="url(#b)" fill="#EA4335" d="M0 11l17 13 7-6.1L48 14V0H0z"/><path clip-path="url(#b)" fill="#34A853" d="M0 37l30-23 7.9 1L48 0v48H0z"/><path clip-path="url(#b)" fill="#4285F4" d="M48 48L17 24l-4-3 35-10z"/></svg>
                Google 계정으로 로그인
            </button>
            <button id="guest-mode-btn" class="btn-3d flex items-center justify-center w-full !text-gray-600">
                로그인 없이 시작하기 (게스트 모드)
            </button>
        </div>
    </div>

    <div id="app-container" style="visibility: hidden;">
        <div class="max-w-4xl mx-auto p-4 pb-24">
            <header class="text-center my-8 flex flex-col sm:flex-row justify-center items-center gap-4">
                <div>
                    <h1 class="text-4xl font-bold text-gray-700" style="text-shadow: 2px 2px 4px #d1d9e6;">AI Vocabulary Builder</h1>
                    <p class="text-gray-500 mt-2">AI와 함께 단어의 모든 것을 탐험하세요</p>
                </div>
                <div id="auth-status" class="card !p-3 !mb-0 ml-0 sm:ml-4 flex items-center gap-2">
                    <span class="text-sm">로그인 정보를 확인 중...</span>
                </div>
            </header>

            <div id="search-bar-container" class="card p-6 mb-8 sticky top-4 z-40">
                <div class="flex flex-col sm:flex-row gap-4">
                    <input
                        type="text"
                        id="search-input"
                        placeholder="영단어 또는 한글 뜻을 입력하세요..."
                        class="w-full px-4 py-3 text-lg border-2 border-slate-300 bg-slate-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition cursor-pointer"
                    >
                    <button id="search-button" class="btn-3d w-full sm:w-auto">
                        <i data-lucide="search" class="inline-block mr-2"></i> 검색
                    </button>
                </div>
            </div>

            <div id="shortcut-buttons" class="card p-4 grid grid-cols-2 md:grid-cols-5 gap-4 text-center">
                <a href="https://www.naver.com" target="_blank" class="btn-3d flex flex-col items-center justify-center p-3 !text-sm text-green-600">
                    <span class="mb-1 font-bold">N</span> 네이버
                </a>
                <a href="https://www.google.com" target="_blank" class="btn-3d flex flex-col items-center justify-center p-3 !text-sm text-blue-600">
                    <i data-lucide="globe-2" class="w-5 h-5 mb-1"></i> Google
                </a>
                <a href="https://www.youtube.com" target="_blank" class="btn-3d flex flex-col items-center justify-center p-3 !text-sm text-red-600">
                    <i data-lucide="youtube" class="w-5 h-5 mb-1"></i> YouTube
                </a>
                <a href="https://www.clien.net" target="_blank" class="btn-3d flex flex-col items-center justify-center p-3 !text-sm text-gray-700">
                    <i data-lucide="message-square" class="w-5 h-5 mb-1"></i> Clien
                </a>
                <a href="https://gemini.google.com/" target="_blank" class="btn-3d flex flex-col items-center justify-center p-3 !text-sm text-purple-600">
                    <i data-lucide="sparkles" class="w-5 h-5 mb-1"></i> Gemini
                </a>
            </div>

            <div id="google-calendar" class="card p-6">
                <h3 class="text-2xl font-bold mb-4 flex items-center text-blue-700">
                    <i data-lucide="calendar" class="mr-2"></i>Google 캘린더
                </h3>
                <div class="w-full h-[600px] rounded-lg overflow-hidden border-2 border-slate-200">
                     <iframe src="https://calendar.google.com/calendar/embed?height=600&wkst=1&ctz=Asia%2FSeoul&showPrint=0&src=aGs2Y2Qzb2ZoYmc3NHRuajA2cjFzNGUxaWNAZ3JvdXAuY2FsZW5kYXIuZ29vZ2xlLmNvbQ&src=a28uc291dGhfa29yZWEjaG9saWRheUBncm91cC52LmNhbGVuZGFyLmdvb2dsZS5jb20&color=%23e67c73&color=%238e24aa&color=%237986cb" style="border:solid 1px #777" width="100%" height="100%" frameborder="0" scrolling="no"></iframe>
                </div>
            </div>

            <div id="loading-container" class="hidden text-center my-10">
                <div class="loader mx-auto"></div>
                <p id="loading-text" class="mt-4 text-gray-600 font-semibold"></p>
                <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2 overflow-hidden">
                    <div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <div id="tab-bar" class="flex flex-wrap items-end border-b-2 border-slate-300 mb-4"></div>

            <main id="tab-content-container"></main>

            <div id="print-only-modal-content" class="hidden"></div>
        </div>

        <footer class="fixed bottom-0 left-0 right-0 bg-white/80 backdrop-blur-sm shadow-t border-t-2 border-slate-200 z-50">
            <div class="max-w-4xl mx-auto flex justify-around p-2">
                <button id="word-list-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition-colors">
                    <i data-lucide="list-checks"></i>
                    <span class="text-xs font-medium">단어 목록</span>
                </button>
                <button id="sentence-list-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition-colors">
                    <i data-lucide="save-all"></i>
                    <span class="text-xs font-medium">예문 저장</span>
                </button>
                <button id="file-storage-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition-colors">
                    <i data-lucide="folder-archive"></i>
                    <span class="text-xs font-medium">파일 보관함</span>
                </button>
                <button id="share-btn" class="flex flex-col items-center text-gray-600 hover:text-blue-600 transition-colors">
                    <i data-lucide="share-2"></i>
                    <span class="text-xs font-medium">공유하기</span>
                </button>
            </div>
        </footer>
    </div>

    <!-- Modals -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 modal" onclick="hideModal(event)">
        <div id="modal-content" class="bg-slate-100 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto p-8 card !mb-0" onclick="event.stopPropagation()"></div>
    </div>

    <div id="image-modal-container" class="fixed inset-0 bg-black bg-opacity-80 hidden items-center justify-center p-4 z-[60] modal" onclick="hideImageModal()">
        <img id="modal-image" src="" class="max-w-full max-h-full object-contain rounded-lg" onclick="event.stopPropagation()">
        <button onclick="hideImageModal()" class="absolute top-4 right-4 text-white hover:text-gray-300 transition" aria-label="Close image view">
            <i data-lucide="x" class="w-10 h-10"></i>
        </button>
    </div>

    <div id="list-modal-container" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 modal" onclick="hideListModal(event)">
        <div class="bg-slate-100 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col card !mb-0" onclick="event.stopPropagation()">
            <div id="list-modal-header" class="p-4 border-b border-slate-300 flex justify-between items-center">
                <h2 id="list-modal-title" class="text-xl font-bold"></h2>
                <button onclick="hideListModal()" class="text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button>
            </div>
            <div class="p-4 flex flex-wrap gap-2 justify-between items-center bg-slate-200 border-b border-slate-300">
                <div>
                    <select id="sort-options" class="px-3 py-1.5 border border-slate-300 rounded-md bg-white"></select>
                </div>
                <div id="list-actions" class="flex flex-wrap gap-2">
                    <button id="mark-read-btn" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 disabled:bg-gray-400" disabled>읽음으로</button>
                    <button id="mark-unread-btn" class="text-sm bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600 disabled:bg-gray-400" disabled>읽지 않음으로</button>
                    <button id="delete-selected-btn" class="text-sm bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600 disabled:bg-gray-400" disabled>선택 삭제</button>
                </div>
            </div>
            <div id="list-modal-content" class="p-6 overflow-y-auto flex-grow"></div>
        </div>
    </div>

    <div id="file-modal-container" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-50 modal" onclick="hideFileModal(event)">
        <div class="bg-slate-100 rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col card !mb-0" onclick="event.stopPropagation()">
            <div class="p-4 border-b border-slate-300 flex justify-between items-center">
                <h2 class="text-xl font-bold">파일 보관함</h2>
                <button onclick="hideFileModal()" class="text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button>
            </div>
            <div class="p-6 border-b border-slate-300">
                <h3 class="font-semibold mb-2">새 파일 올리기 (50MB 이하)</h3>
                <input type="file" id="file-upload-input" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <button id="file-upload-button" class="btn-3d mt-4 w-full">업로드</button>
                <div id="upload-progress-container" class="hidden mt-2">
                    <div class="w-full bg-gray-200 rounded-full h-2.5">
                        <div id="upload-progress-bar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                </div>
            </div>
            <div id="file-list" class="p-6 overflow-y-auto flex-grow"></div>
        </div>
    </div>

    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-60 hidden items-center justify-center p-4 z-[70] modal">
        <div class="bg-slate-100 rounded-2xl shadow-2xl max-w-sm w-full p-6 card !mb-0">
            <h3 id="confirmation-title" class="text-lg font-bold mb-4">확인</h3>
            <p id="confirmation-message" class="mb-6">이 작업을 정말로 실행하시겠습니까?</p>
            <div class="flex justify-end gap-4">
                <button id="confirm-cancel-btn" class="btn-3d">취소</button>
                <button id="confirm-ok-btn" class="btn-3d !bg-red-500 !text-white hover:!bg-red-600">확인</button>
            </div>
        </div>
    </div>

    <div id="search-choice-modal" class="modal-background hidden fixed inset-0 bg-black bg-opacity-60 items-center justify-center p-4 z-[80]">
      <div class="modal-content-container bg-slate-100 rounded-2xl shadow-2xl max-w-sm w-full p-6 card !mb-0">
        <h3 class="text-xl font-bold mb-4">검색 옵션</h3>
        <p class="mb-6">
          '<span id="search-choice-word" class="font-bold text-blue-600"></span>' 단어는 이미 저장된 페이지가 있습니다.
        </p>
        <div class="flex justify-end gap-4">
          <button id="search-choice-cancel-btn" class="btn-3d !bg-gray-400 hover:!bg-gray-500">취소</button>
          <button id="search-choice-new-search-btn" class="btn-3d !bg-green-500 hover:!bg-green-600">
            <i data-lucide="search" class="inline-block mr-2 w-4 h-4"></i>새로 검색
          </button>
          <button id="search-choice-load-saved-btn" class="btn-3d">
            <i data-lucide="download" class="inline-block mr-2 w-4 h-4"></i>저장된 페이지 로드
          </button>
        </div>
      </div>
    </div>

    <div id="toast-container" class="toast fixed bottom-24 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg">
        <p id="toast-message"></p>
    </div>

    <div id="word-tooltip" class="hidden absolute z-[100] px-3 py-1.5 text-sm font-medium text-white bg-gray-900 rounded-lg shadow-sm"></div>

    <div id="print-container" style="display: none;">
        <div class="print-header">
            <h1 class="text-4xl">AI Vocabulary Builder</h1>
            <p>AI와 함께 단어의 모든 것을 탐험하세요</p>
            <hr style="border: 1px solid #ccc; margin-top: 10px;">
        </div>
        <div id="print-content-area"></div>
    </div>

    <!-- MAIN SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, addDoc, writeBatch, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject, uploadBytes } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // === Updated Firebase Config ===
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyC-UisM1j624UWaQESMGCtYAuvkimpjBI8",
            authDomain: "projec-48c55.firebaseapp.com",
            projectId: "projec-48c55",
            storageBucket: "projec-48c55.appspot.com",
            messagingSenderId: "376464552007",
            appId: "1:376464552007:web:929b53196fc86af19dc162",
            measurementId: "G-HMKJMNFGM4"
        };

        // 0. Initial Setup & Variable Declaration
        let searchInput, searchButton, loadingContainer, loadingText, progressBar, searchBarContainer,
            printContainer, printContentArea, modalContainer, modalContent, imageModalContainer,
            modalImage, wordTooltip, fileModalContainer, fileUploadInput, fileUploadButton,
            listModalContainer, listModalTitle, listModalContent, sortOptions, markReadBtn,
            markUnreadBtn, deleteSelectedBtn, confirmCallback, confirmationModal,
            confirmationMessage, confirmOkBtn, confirmCancelBtn,
            searchChoiceModal, searchChoiceWord, searchChoiceLoadSavedBtn, 
            searchChoiceNewSearchBtn, searchChoiceCancelBtn,
            currentChoicePageData;

        // Gemini API Configuration
        const GOOGLE_API_KEY = "AIzaSyC-UisM1j624UWaQESMGCtYAuvkimpjBI8";
        const TEXT_MODEL = "gemini-2.5-flash-preview-09-2025";
        const IMAGE_MODEL = "imagen-4.0-generate-001"; // Updated to 4.0

        const translationCache = {};

        // Firebase Setup
        let db, auth, storage, userId;
        let app;
        const appId = 'default-ai-vocab-app';

        // Tab Management
        let tabs = {};
        let activeTabId = null;
        let tabCounter = 0;
        let savedWords = [];
        let savedSentences = [];

        // =========================================================================
        // === 1. 이미지 생성 함수 (Google Imagen 4.0) ===
        // =========================================================================

        async function callImagenWithRetry(prompt, retries = 3) {
            try {
                // Google Imagen API Endpoint (4.0)
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_MODEL}:predict?key=${GOOGLE_API_KEY}`;
                
                const payload = {
                    instances: [
                        { prompt: prompt }
                    ],
                    parameters: {
                        sampleCount: 1,
                        // aspectRatio: "1:1" // Optional
                    }
                };

                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Google Image Gen failed: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                
                // Extract Base64
                const base64Image = result.predictions?.[0]?.bytesBase64Encoded;
                
                if (!base64Image) {
                    throw new Error("No image data returned from Google API");
                }

                const dataUrl = `data:image/png;base64,${base64Image}`;

                return { url: dataUrl, status: 'success' };

            } catch (e) {
                console.error("Image generation failed:", e);
                // 실패 시 깔끔한 대체 이미지 반환
                return { 
                    url: `https://placehold.co/1024x1024/e0e5ec/4a5568?text=Image+Generation+Failed`, 
                    status: 'failed' 
                };
            }
        }

        // =========================================================================
        // === 2. API Communication Wrapper (Direct to Google) ===
        // =========================================================================

        async function callGemini(prompt, isJson = false, base64Image = null) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${GOOGLE_API_KEY}`;
            
            const parts = [{ text: prompt }];
            
            if (base64Image) {
                // If the base64Image is a Data URL, strip the prefix
                const cleanBase64 = base64Image.replace(/^data:image\/(png|jpeg|webp);base64,/, "");
                parts.push({
                    inlineData: {
                        mimeType: "image/png",
                        data: cleanBase64
                    }
                });
            }

            const payload = {
                contents: [{ parts: parts }]
            };

            if (isJson) {
                payload.generationConfig = { responseMimeType: "application/json" };
            }

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Gemini API failed: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (!text) { 
                    console.error("Empty response from Gemini:", result); 
                    throw new Error("Gemini API response is empty."); 
                }

                if (isJson) {
                    let jsonString = text.trim();
                    if (jsonString.startsWith("```json")) { jsonString = jsonString.slice(7, -3).trim(); }
                    else if (jsonString.startsWith("```")) { jsonString = jsonString.slice(3, -3).trim(); }
                    try { return JSON.parse(jsonString); }
                    catch (error) { 
                        console.error("Failed to parse JSON:", error); 
                        console.error("Original text from API:", text); 
                        throw error; 
                    }
                }
                return text;

            } catch (error) {
                console.error("API Call Error:", error);
                // showToast("AI 응답 오류: 잠시 후 다시 시도해주세요.", "error");
                throw error;
            }
        }

        // ... (UI Logic and Helpers) ...

        function showSearchChoiceModal(word, pageData) {
            searchChoiceWord.textContent = word;
            currentChoicePageData = pageData;
            searchChoiceModal.classList.remove('hidden');
            searchChoiceModal.classList.add('flex');
            safeCreateIcons();
        }

        function hideSearchChoiceModal() {
            searchChoiceModal.classList.add('hidden');
            searchChoiceModal.classList.remove('flex');
            currentChoicePageData = null;
        }

        async function loadSavedPageFromChoice() {
            const word = searchChoiceWord.textContent;
            showToast("저장된 페이지를 불러옵니다...", "info");
            const tabId = addTab(word, true);
            const currentTab = tabs[tabId];
            currentTab.fullSearchResult = currentChoicePageData;
            await renderSavedPage(currentTab, currentChoicePageData);
            hideSearchChoiceModal();
        }

        function renderFileList(files) {
            const fileListDiv = document.getElementById('file-list');
            if (files.length === 0) {
                fileListDiv.innerHTML = '<p class="text-center text-gray-500">업로드된 파일이 없습니다.</p>';
                return;
            }
            fileListDiv.innerHTML = '';
            files.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

            files.forEach(fileData => {
                const fileElement = document.createElement('div');
                fileElement.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-slate-200';
                fileElement.innerHTML = `
                    <div class="truncate">
                        <p class="font-semibold truncate">${fileData.name}</p>
                        <p class="text-sm text-gray-500">${(fileData.size / 1024 / 1024).toFixed(2)} MB</p>
                    </div>
                    <div class="flex items-center gap-1 flex-shrink-0">
                        <button class="icon-btn" onclick="downloadFile('${fileData.fullPath}')">${createDownloadIcon()}</button>
                        <button class="icon-btn text-red-500" onclick="deleteFile('${fileData.id}', '${fileData.fullPath}')">${createTrashIcon()}</button>
                    </div>
                `;
                fileListDiv.appendChild(fileElement);
            });
            safeCreateIcons();
        }

        function showToast(message, type = "info") {
            const toast = document.getElementById('toast-container');
            const toastMessage = document.getElementById('toast-message');
            toastMessage.textContent = message;

            toast.className = 'toast show fixed bottom-24 right-5 text-white px-6 py-3 rounded-lg shadow-lg';
            if (type === 'success') toast.classList.add('bg-green-600');
            else if (type === 'error') toast.classList.add('bg-red-600');
            else if (type === 'warning') toast.classList.add('bg-yellow-500');
            else toast.classList.add('bg-gray-800');

            setTimeout(() => { toast.className = 'toast'; }, 3000);
        }

        function loadUserLists() {
            if (!db || !userId) return;
            const wordsQuery = query(collection(db, `artifacts/${appId}/users/${userId}/saved_words`));
            onSnapshot(wordsQuery, (snapshot) => {
                savedWords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(window.currentListType === 'words') window.renderList();
            }, (error) => console.error("Error loading words:", error));

            const sentencesQuery = query(collection(db, `artifacts/${appId}/users/${userId}/saved_sentences`));
            onSnapshot(sentencesQuery, (snapshot) => {
                savedSentences = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(window.currentListType === 'sentences') window.renderList();
            }, (error) => console.error("Error loading sentences:", error));
        }

        function listenForFiles() {
            if (!db || !userId) return;
            const filesQuery = query(collection(db, `artifacts/${appId}/users/${userId}/file_metadata`));
            onSnapshot(filesQuery, (snapshot) => {
                const files = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderFileList(files);
            }, (error) => {
                console.error("Error listening for files:", error);
                const fileListDiv = document.getElementById('file-list');
                fileListDiv.innerHTML = '<p class="text-center text-red-500">파일 목록을 불러오는 데 실패했습니다.</p>';
            });
        }

        function safeCreateIcons() {
            if (window.lucide) {
                window.lucide.createIcons();
            }
        }

        function base64ToBlob(base64, contentType = 'image/png') {
            const base64Data = base64.split(',')[1];
            if (!base64Data) {
                throw new Error("Invalid base64 string");
            }
            const sliceSize = 512;
            const byteCharacters = atob(base64Data);
            const byteArrays = [];
            for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                const slice = byteCharacters.slice(offset, offset + sliceSize);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }
            return new Blob(byteArrays, {type: contentType});
        }

        async function uploadBase64Image(base64String, storagePath) {
            const blob = base64ToBlob(base64String);
            const storageRef = ref(storage, storagePath);
            await uploadBytes(storageRef, blob); 
            return await getDownloadURL(storageRef);
        }

        // =========================================================================

        async function initializeFirebase() {
            searchInput = document.getElementById('search-input');
            searchButton = document.getElementById('search-button');
            loadingContainer = document.getElementById('loading-container');
            loadingText = document.getElementById('loading-text');
            progressBar = document.getElementById('progress-bar');
            searchBarContainer = document.getElementById('search-bar-container');
            printContainer = document.getElementById('print-container');
            printContentArea = document.getElementById('print-content-area');
            modalContainer = document.getElementById('modal-container');
            modalContent = document.getElementById('modal-content');
            imageModalContainer = document.getElementById('image-modal-container');
            modalImage = document.getElementById('modal-image');
            wordTooltip = document.getElementById('word-tooltip');
            fileModalContainer = document.getElementById('file-modal-container');
            fileUploadInput = document.getElementById('file-upload-input');
            fileUploadButton = document.getElementById('file-upload-button');
            listModalContainer = document.getElementById('list-modal-container');
            listModalTitle = document.getElementById('list-modal-title');
            listModalContent = document.getElementById('list-modal-content');
            sortOptions = document.getElementById('sort-options');
            markReadBtn = document.getElementById('mark-read-btn');
            markUnreadBtn = document.getElementById('mark-unread-btn');
            deleteSelectedBtn = document.getElementById('delete-selected-btn');
            confirmationModal = document.getElementById('confirmation-modal');
            confirmationMessage = document.getElementById('confirmation-message');
            confirmOkBtn = document.getElementById('confirm-ok-btn');
            confirmCancelBtn = document.getElementById('confirm-cancel-btn');
            confirmCallback = null;

            searchChoiceModal = document.getElementById('search-choice-modal');
            searchChoiceWord = document.getElementById('search-choice-word');
            searchChoiceLoadSavedBtn = document.getElementById('search-choice-load-saved-btn');
            searchChoiceNewSearchBtn = document.getElementById('search-choice-new-search-btn');
            searchChoiceCancelBtn = document.getElementById('search-choice-cancel-btn');
            currentChoicePageData = null;

            // Prioritize environment config if available to avoid domain blocking issues
            let firebaseConfig;
            if (typeof __firebase_config !== 'undefined') {
                try {
                    firebaseConfig = JSON.parse(__firebase_config);
                } catch (e) {
                    console.warn("Failed to parse __firebase_config, using user config", e);
                    firebaseConfig = USER_FIREBASE_CONFIG;
                }
            } else {
                firebaseConfig = USER_FIREBASE_CONFIG;
            }

            try {
                if (!firebaseConfig.apiKey) {
                    console.error("Firebase config is missing.");
                    showToast("Firebase 구성 정보가 누락되었습니다.", "error");
                    document.getElementById('app-container').style.visibility = 'visible';
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app, firebaseConfig.storageBucket ? `gs://${firebaseConfig.storageBucket}` : undefined);
                setLogLevel('silent'); // Suppress verbose logs to reduce console noise
                
                // Robust Auth Flow
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            // If no custom token, try anonymous sign-in implicitly or wait for user action
                            // The prompt says "Auth Before Queries". 
                            // If we rely on Google Sign In popup, we might not need signInAnonymously immediately 
                            // unless we want to allow public read access or user-specific data via anonymous uid.
                            // Given the app structure relies on `userId`, we should probably sign in anonymously if no user.
                            // However, due to the CORS error, even anonymous sign-in might fail if the domain is blocked.
                            // We wrap this in try-catch to allow the app to load even if auth fails.
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Auto-sign-in failed (likely domain restriction):", error);
                        // Do NOT throw error, just log it. Allow app to proceed in "Guest Mode" (unauthenticated).
                    }
                };

                await initAuth();

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated. User ID:", userId);
                        document.getElementById('auth-status').innerHTML = `
                            <span class="text-sm">환영합니다, ${user.displayName || '게스트'}님</span>
                            <button id="google-logout-btn" class="btn-3d !p-2 !text-xs !bg-red-400 !text-white hover:!bg-red-500">로그아웃</button>
                        `;
                        document.getElementById('google-logout-btn').onclick = () => signOut(auth);
                        
                        document.getElementById('app-container').style.visibility = 'visible';
                        document.getElementById('auth-container').classList.add('hidden');
                        
                        searchInput.disabled = false;
                        searchInput.classList.remove('cursor-pointer', 'disabled:cursor-not-allowed');
                        searchInput.placeholder = "영단어 또는 한글 뜻을 입력하세요...";

                        loadUserLists();
                        listenForFiles();

                        if (window.location.pathname.startsWith('/__/auth/handler')) {
                            window.history.replaceState({}, document.title, '/');
                        }

                    } else {
                        userId = null;
                        console.log("User is signed out or auth failed.");
                        document.getElementById('auth-status').innerHTML = `
                            <span class="text-sm">게스트 모드 (저장 불가)</span>
                        `;
                        
                        // Normally we hide app and show login, but due to auth error loop, 
                        // we show app container if auth failed but we want guest access.
                        // However, standard flow is: show login modal.
                        document.getElementById('app-container').style.visibility = 'hidden';
                        document.getElementById('auth-container').classList.remove('hidden');

                        searchInput.disabled = true;
                        searchInput.classList.add('cursor-pointer', 'disabled:cursor-not-allowed');
                        searchInput.placeholder = "로그인이 필요합니다...";

                        savedWords = [];
                        savedSentences = [];
                        renderFileList([]);
                    }
                    safeCreateIcons();
                });

            } catch (error) {
                console.error("Firebase Initialization Critical Error: ", error);
                // Even on critical error, show the app so they can use Gemini features
                showToast("데이터베이스 연결 실패. 게스트 모드로 실행됩니다.", "warning");
                document.getElementById('app-container').style.visibility = 'visible';
                document.getElementById('auth-container').classList.add('hidden'); 
            }

            confirmOkBtn.addEventListener('click', () => { if (confirmCallback) { confirmCallback(); } hideConfirmationModal(); });
            confirmCancelBtn.addEventListener('click', hideConfirmationModal);

            searchChoiceLoadSavedBtn.addEventListener('click', loadSavedPageFromChoice);
            searchChoiceNewSearchBtn.addEventListener('click', () => {
                const word = searchChoiceWord.textContent;
                executeSearchForWord(word); 
                hideSearchChoiceModal();
            });
            searchChoiceCancelBtn.addEventListener('click', hideSearchChoiceModal);

            fileUploadButton.addEventListener('click', () => { 
                if (!auth || !auth.currentUser) { showToast("로그인이 필요한 기능입니다.", "error"); return; } 
                const file = fileUploadInput.files[0]; 
                if (!file) { showToast("파일을 선택해주세요.", "warning"); return; } 
                if (file.size > 50 * 1024 * 1024) { showToast("파일 크기는 50MB를 초과할 수 없습니다.", "error"); return; } 
                const storagePath = `artifacts/${appId}/users/${userId}/files/${file.name}`; 
                const storageRef = ref(storage, storagePath); 
                const uploadProgressContainer = document.getElementById('upload-progress-container'); 
                const uploadProgressBar = document.getElementById('upload-progress-bar'); 
                uploadProgressContainer.classList.remove('hidden'); 
                fileUploadButton.disabled = true; 
                const uploadTask = uploadBytesResumable(storageRef, file); 
                uploadTask.on('state_changed', 
                    (snapshot) => { const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100; uploadProgressBar.style.width = progress + '%'; }, 
                    (error) => { console.error("Upload failed. Firebase Error Code:", error.code); console.error("Full Error:", error); showToast(`파일 업로드 실패: ${error.code}`, "error"); uploadProgressContainer.classList.add('hidden'); uploadProgressBar.style.width = '0%'; fileUploadButton.disabled = false; }, 
                    async () => { 
                        let firestoreError = null; 
                        try { 
                            const metadata = uploadTask.snapshot.metadata; 
                            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/file_metadata`), { name: metadata.name, fullPath: metadata.fullPath, size: metadata.size, contentType: metadata.contentType, timestamp: new Date() }); 
                        } catch (error) { 
                            firestoreError = error; console.error("Firestore metadata save error:", error.code, error.message); showToast(`파일 정보 저장 실패: ${error.code}`, "error"); 
                            await deleteObject(uploadTask.snapshot.ref).catch(err => console.error("Orphaned file cleanup failed:", err)); 
                        } finally { 
                            uploadProgressContainer.classList.add('hidden'); uploadProgressBar.style.width = '0%'; fileUploadInput.value = ''; fileUploadButton.disabled = false; 
                            if (!firestoreError) { showToast("파일 업로드 성공.", "success"); } 
                        } 
                    }
                ); 
            });

            listModalContent.addEventListener('change', (e) => { if (e.target.classList.contains('item-checkbox')) { updateListActionButtonsState(); } });

            document.addEventListener('mouseover', async (e) => { 
                if (e.target.classList.contains('clickable-word')) { 
                    // Allow translation even without userId (Guest Mode)
                    const word = e.target.textContent.trim().replace(/[^a-zA-Z-]/g, ''); 
                    if (!word) return; 
                    const translation = await translateWordOnHover(word); 
                    wordTooltip.textContent = translation; 
                    wordTooltip.classList.remove('hidden'); 
                    const rect = e.target.getBoundingClientRect(); 
                    wordTooltip.style.left = `${rect.left + window.scrollX + rect.width / 2 - wordTooltip.offsetWidth / 2}px`; 
                    wordTooltip.style.top = `${rect.top + window.scrollY - wordTooltip.offsetHeight - 5}px`; 
                } 
            });

            document.addEventListener('mouseout', (e) => { if (e.target.classList.contains('clickable-word')) { wordTooltip.classList.add('hidden'); } });

            document.addEventListener('click', (e) => { 
                if (e.target.classList.contains('clickable-word')) { 
                    // Allow click search even without userId (Guest Mode)
                    const word = e.target.textContent.trim().replace(/[^a-zA-Z-]/g, ''); 
                    if (word) { 
                        searchInput.value = word; 
                        checkAndLoadPage(word); 
                        hideListModal(); 
                    } 
                } 
                const listItemTarget = e.target.closest('.searchable-list-item'); 
                if (listItemTarget) { 
                    const word = listItemTarget.dataset.word; 
                    if(word) {
                        searchInput.value = word;
                        checkAndLoadPage(word);
                        hideListModal(); 
                    }
                }
            });

            searchInput.addEventListener('keydown', (e) => { 
                if (e.key === 'Enter') { 
                    // Allow search without userId check here, handleSearch handles it
                    handleSearch(searchInput.value.trim()); 
                } 
            });
            document.getElementById('word-list-btn').addEventListener('click', () => showListModal('words'));
            document.getElementById('sentence-list-btn').addEventListener('click', () => showListModal('sentences'));
            document.getElementById('file-storage-btn').addEventListener('click', showFileModal);
            document.getElementById('share-btn').addEventListener('click', () => { if(navigator.share) { navigator.share({ title: 'AI Vocabulary Builder', text: 'AI와 함께 새로운 단어를 배워보세요!', url: window.location.href }).catch(err => console.error("Share failed", err)); } else { try { navigator.clipboard.writeText(window.location.href); showToast("링크가 클립보드에 복사되었습니다.", "success"); } catch (err) { console.error("Clipboard write failed:", err); showToast("클립보드 복사 실패.", "error"); } } });
            sortOptions.addEventListener('change', (e) => { currentSort = e.target.value; renderList(); });
            markReadBtn.addEventListener('click', () => performBulkAction('mark-read'));
            markUnreadBtn.addEventListener('click', () => performBulkAction('mark-unread')); 
            deleteSelectedBtn.addEventListener('click', () => performBulkAction('delete'));
            
            // Authentication Button
            document.getElementById('google-login-btn').addEventListener('click', signInWithGoogle);
            
            // Guest Mode Button Logic
            document.getElementById('guest-mode-btn').addEventListener('click', () => {
                document.getElementById('app-container').style.visibility = 'visible';
                document.getElementById('auth-container').classList.add('hidden');
                
                searchInput.disabled = false;
                searchInput.classList.remove('cursor-pointer', 'disabled:cursor-not-allowed');
                searchInput.placeholder = "영단어 또는 한글 뜻을 입력하세요... (게스트 모드)";
                
                showToast("게스트 모드로 시작합니다. 저장 기능은 제한됩니다.", "info");
            });

        } 

        window.signInWithGoogle = async function() {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                console.log("Popup Sign-In successful:", result.user.displayName);
                showToast(`${result.user.displayName}님, 환영합니다!`, "success");
            } catch (error) {
                console.error("Google Sign-In Popup Error:", error);
                if (error.code === 'auth/requests-from-referer-blocked' || error.message.includes('referer')) {
                     showToast("도메인 보안 설정으로 인해 로그인이 차단되었습니다. 게스트 모드를 이용해주세요.", "error");
                } else if (error.code !== 'auth/popup-closed-by-user') {
                    showToast("Google 팝업 로그인에 실패했습니다.", "error");
                }
            }
        }

        // ---------------------------
        // Core Logic
        // ---------------------------

        window.checkSearchAccess = function() {
            handleSearch(searchInput.value.trim());
        }

        async function checkAndLoadPage(word) {
            if (!db || !userId) {
                // If guest mode or db error, just search directly (skip checking saved pages)
                executeSearchForWord(word); 
                return;
            }
            const normalizedWord = word.toLowerCase();
            const pageRef = doc(db, `artifacts/${appId}/users/${userId}/saved_pages/${normalizedWord}`);
            
            try {
                const docSnap = await getDoc(pageRef);
                if (docSnap.exists()) {
                    const pageData = docSnap.data().pageData;
                    showSearchChoiceModal(word, pageData);
                } else {
                    executeSearchForWord(word);
                }
            } catch (error) {
                console.error("Error checking for saved page:", error);
                // If permission denied or other error, fallback to new search
                executeSearchForWord(word); 
            }
        }


        async function handleSearch(query) {
            if (!userId) { 
                // Show a gentle reminder toast but ALLOW search
                showToast("게스트 모드: 검색 결과는 저장되지 않습니다.", "info"); 
            } 
            if (!query) { showToast("검색어를 입력해주세요.", "warning"); return; }
            
            const isKorean = /[ㄱ-ㅎ|ㅏ-ㅣ|가-힣]/.test(query);
            if (isKorean) {
                showLoader(0, `'${query}'에 대한 의미 확인 중...`);
                try {
                    const ambiguityPrompt = `한국어 단어 "${query}"가 여러 개의 뚜렷하게 다른 영어 단어로 번역될 수 있나요? (예: '배' -> ship, pear, stomach). 다음 JSON 형식으로만 대답해줘: {"is_ambiguous": boolean, "english_words": ["단어1", "단어2", ...]}. 모호하지 않으면 "english_words" 배열에 대표 영어 단어 하나만 포함해줘.`;
                    const ambiguityData = await callGemini(ambiguityPrompt, true);
                    
                    const normalizedEnglishWords = ambiguityData.english_words
                        .filter(word => word) 
                        .map(word => word.toLowerCase().trim()); 
                        
                    const uniqueEnglishWords = [...new Set(normalizedEnglishWords)]; 
                    
                    if (ambiguityData.is_ambiguous && uniqueEnglishWords.length > 1) {
                        showToast(`'${query}'에 대해 ${uniqueEnglishWords.length}개의 의미를 찾았습니다. 각각 탭으로 표시합니다.`, "info");
                        for (let i = 0; i < uniqueEnglishWords.length; i++) {
                            const word = uniqueEnglishWords[i];
                            await checkAndLoadPage(word);
                        }
                    } else { 
                        const wordToSearch = uniqueEnglishWords[0] || query;
                        await checkAndLoadPage(wordToSearch); 
                    }
                } catch (error) { 
                    console.error("Ambiguity check failed:", error); 
                    showToast("단어 의미 확인 중 오류가 발생했습니다.", "error"); 
                    await checkAndLoadPage(query); 
                }
                finally { hideLoader(); }
            } else { 
                await checkAndLoadPage(query); 
            }
        }

        async function executeSearchForWord(wordQuery, makeActive = true) {
            const tabId = addTab(wordQuery, makeActive);
            const currentTab = tabs[tabId];
            const contentContainer = currentTab.contentEl;
            contentContainer.innerHTML = '';
            const searchId = ++currentTab.searchId;
            currentTab.fullSearchResult = {};
            currentTab.imageLoadPromises = []; 
            showLoader(0, `"${wordQuery}" 검색을 시작합니다...`);
            searchButton.disabled = true;
            const headerHeight = document.querySelector('header').offsetHeight || 100;
            window.scrollTo({ top: headerHeight, behavior: 'smooth' });
            try {
                updateLoader(10, "기본 정보 생성 중...");
                const initialInfoPrompt = `영어 단어 "${wordQuery}"에 대한 종합적인 정보를 생성해줘. 다음 JSON 형식을 반드시 따라줘:\n{\n  "word": "실제 영어 단어 (소문자로)",\n  "koreanMeaning": "대표적인 한글 뜻",\n  "pronunciation": "발음 기호",\n  "mainImagePrompt": "단어를 함축적으로 표현하는, 예술적이고 상세한 이미지 생성을 위한 영어 프롬프트. 예: 'brain' -> 'A hyper-realistic, detailed anatomical illustration of the human brain, showing different lobes with glowing neural pathways, artistic style.'",\n  "episode": {\n    "story": "단어를 쉽게 기억할 수 있는 매우 웃기고 재미있는 짧은 이야기 (3~4 문장).",\n    "story_ko": "위 이야기의 자연스러운 한글 번역.",\n    "imagePrompt": "이야기 내용에 맞는, 밝고 유머러스한 만화 스타일의 이미지 생성을 위한 영어 프롬프트. 예: 'Dr. Slump' 만화 스타일."\n  }\n}`;
                const initialData = await callGemini(initialInfoPrompt, true);
                
                initialData.word = initialData.word.toLowerCase();
                
                currentTab.fullSearchResult.initialData = initialData;
                if (searchId !== currentTab.searchId) return;
                updateLoader(25, "기본 정보 표시 중...");
                
                renderPrintButton(currentTab);
                renderSavePageButton(currentTab); 
                
                const placeholderImg = "https://placehold.co/300x300/e0e5ec/4a5568?text=Loading...";
                renderBasicInfo(initialData, placeholderImg, contentContainer);
                renderEpisode(initialData, placeholderImg, contentContainer);
                addWordToHistory(initialData.word, initialData.koreanMeaning);
                
                // === Main Image Generation (Direct Google Call) ===
                const mainImagePromise = new Promise((resolve, reject) => {
                    callImagenWithRetry(initialData.mainImagePrompt).then(imageResult => {
                        currentTab.fullSearchResult.mainImageUrl = imageResult.url; 
                        if (searchId === currentTab.searchId) {
                            const imgEl = contentContainer.querySelector('#main-image');
                            if (imgEl) {
                                imgEl.onload = () => resolve({ type: 'main', ...imageResult });
                                imgEl.onerror = () => reject(new Error('Main image load fail'));
                                imgEl.src = imageResult.url;
                                if (imageResult.status === 'success') { imgEl.onclick = () => showImageAnalysisModal(imageResult.url, initialData.word, initialData.koreanMeaning); }
                                else if (imageResult.status === 'policy_failed') { imgEl.title = "정책 필터링으로 인해 이미지를 표시할 수 없습니다."; imgEl.onclick = () => showToast("경고: 이미지가 정책에 의해 필터링되었습니다.", "warning"); }
                                else { imgEl.title = "이미지 생성에 실패했습니다."; imgEl.onclick = () => showToast("경고: 이미지 생성에 실패했습니다.", "error"); }
                            } else { reject(new Error('Main image element not found')); }
                        } else { reject(new Error('Tab changed')); }
                    }).catch(e => reject(e));
                });
                currentTab.imageLoadPromises.push(mainImagePromise);
                
                // === Episode Image Generation (Direct Google Call) ===
                const episodeImagePromise = new Promise((resolve, reject) => {
                    callImagenWithRetry(initialData.episode.imagePrompt).then(imageResult => {
                        currentTab.fullSearchResult.episodeImageUrl = imageResult.url; 
                        if (searchId === currentTab.searchId) {
                            const imgEl = contentContainer.querySelector('#episode-image');
                            if (imgEl) {
                                imgEl.onload = () => resolve({ type: 'episode', ...imageResult });
                                imgEl.onerror = () => reject(new Error('Episode image load fail'));
                                imgEl.src = imageResult.url;
                                imgEl.onclick = () => showImageModal(imageResult.url); 
                            } else { reject(new Error('Episode image element not found')); }
                        } else { reject(new Error('Tab changed')); }
                    }).catch(e => reject(e));
                });
                currentTab.imageLoadPromises.push(episodeImagePromise);

                updateLoader(40, "의미 분석 생성 중...");
                const meaningsPrompt = `영어 단어 "${initialData.word}"의 의미를 분석해줘. 핵심 의미, 부가적 의미, 숙어 표현 각각에 대해 설명과 대표 예문, 그리고 그 예문에 맞는 'Dr. Slump' 스타일의 재미있는 삽화 프롬프트를 생성해줘. 다음 JSON 형식을 반드시 따라줘:\n[\n  { "type": "핵심 의미", "description": "핵심 의미에 대한 자세한 한글 설명.", "exampleSentence": "의미를 가장 잘 나타내는 현대적이고 일반적인 영어 예문.", "exampleSentenceTranslation": "위 예문의 한글 번역.", "imagePrompt": "위 예문 내용을 기반으로, 'Dr.slump' 만화 스타일의 재미있는 삽화 생성을 위한 영어 프롬프트. 인물 표정은 다양하고 재미있게." },\n  { "type": "부가적 의미", "description": "부가적, 비유적, 확장된 의미에 대한 한글 설명.", "exampleSentence": "해당 의미를 보여주는 창의적인 영어 예문.", "exampleSentenceTranslation": "위 예문의 한글 번역.", "imagePrompt": "위 예문 내용을 기반으로 한 삽화 프롬프트." },\n  { "type": "숙어 표현", "description": "단어가 포함된 중요 숙어와 그 의미에 대한 한글 설명.", "exampleSentence": "숙어가 사용된 자연스러운 영어 예문.", "exampleSentenceTranslation": "위 예문의 한글 번역.", "imagePrompt": "위 예문 내용을 기반으로 한 삽화 프롬프트." }\n]`;
                const meaningsData = await callGemini(meaningsPrompt, true);
                currentTab.fullSearchResult.meaningsData = meaningsData;
                if (searchId !== currentTab.searchId) return;
                
                await renderMeanings(meaningsData, initialData.word, searchId, currentTab, contentContainer);
                
                renderSentenceCrafter(initialData.word, contentContainer);
                updateLoader(75, "심화 학습 정보 생성 중...");
                const fastDeepDivePrompt = `영어 단어 "${initialData.word}"에 대한 심화 학습 콘텐츠를 생성해줘. "encyclopedia"는 제외하고 다음 JSON 형식을 반드시 따라줘:\n{\n  "quotes": [\n    {"quote": "관련 명언/유명 문구 1", "translation": "한글 번역"},\n    {"quote": "관련 명언/유명 문구 2", "translation": "한글 번역"},\n    {"quote": "관련 명언/유명 문구 3", "translation": "한글 번역"}\n  ],\n  "synonyms": ["유의어1(뜻1)", "유의어2(뜻2)", "유의어3(뜻3)"],\n  "antonyms": ["반의어1(뜻1)", "반의어2(뜻2)"],\n  "conceptTree": { "superordinate": ["상위 개념 (영어(한글))"], "coordinate": ["동위 개념 1 (영어(한글))", "...(총 10개)"], "subordinate": ["하위 개념 1 (영어(한글))", "...(총 20개)"] },\n  "dialogue": [\n    {"speaker": "A", "line": "대화 문장 1 (영어)", "translation": "대화 문장 1 (한글)"},\n    {"speaker": "B", "line": "대화 문장 2 (영어)", "translation": "대화 문장 2 (한글)"}\n  ],\n  "quiz": [\n    { "question": "난이도 높은 4지선다 퀴즈 문제 1", "options": ["선택지 A", "선택지 B", "선택지 C", "선택지 D"], "answer": "정답 선택지", "explanation": "정답에 대한 상세한 한글 해설. 퀴즈 문제 문장에 대한 한글 해석을 반드시 포함해야 합니다." }\n  ]\n}`;
                const fastDeepDiveData = await callGemini(fastDeepDivePrompt, true);
                currentTab.fullSearchResult.fastDeepDiveData = fastDeepDiveData;
                if (searchId !== currentTab.searchId) return;
                updateLoader(90, "심화 정보 표시 중...");
                const buttonContainer = renderDeepDiveButtonsContainer(contentContainer);
                appendConceptTreeButton(buttonContainer, fastDeepDiveData.conceptTree);
                renderDeepDive(fastDeepDiveData, contentContainer);
                
                Promise.all(currentTab.imageLoadPromises.map(p => p.catch(e => e)))
                    .then(results => {
                        console.log("All image generation/loads complete:", results);
                        if (searchId === currentTab.searchId) {
                            const saveButton = currentTab.contentEl.querySelector(`#save-page-btn-${currentTab.id}`);
                            if (saveButton) {
                                saveButton.disabled = false;
                                saveButton.innerHTML = `💾 이 페이지 저장하기`;
                                safeCreateIcons();
                            }
                        }
                    });

                hideLoader();
                showToast("핵심 정보 로딩 완료! 백과사전 정보를 생성합니다...", "info");
                const encyclopediaPrompt = `영어 단어 "${initialData.word}"에 대한 백과사전식 설명을 생성해줘. A4 용지 3장 분량에 준하는 상세한 내용이어야 하며, '어원', '역사적 배경', '문학/현대에서의 사용' 섹션을 포함하여 구조화해줘. 다음 JSON 형식만 따라줘:\n{ \n  "encyclopedia": { \n    "introduction": "상세한 서론 (영어, 여러 문단)", "etymology": "깊이 있는 어원 분석 (영어, 여러 문단)", "history": "포괄적인 역사적 배경과 변화 과정 (영어, 여러 문단)", "usage": "문학, 현대 미디어, 일상에서의 사용 예시 (영어, 여러 문단)",\n    "introduction_ko": "위 내용의 한글 번역", "etymology_ko": "위 내용의 한글 번역", "history_ko": "위 내용의 한글 번역", "usage_ko": "위 내용의 한글 번역"\n  }\n}`;
                const encyclopediaFullData = await callGemini(encyclopediaPrompt, true);
                if (searchId !== currentTab.searchId) return;
                currentTab.fullSearchResult.encyclopediaData = encyclopediaFullData;
                appendEncyclopediaButton(buttonContainer, encyclopediaFullData.encyclopedia);
                showToast("모든 콘텐츠 생성이 완료되었습니다!", "success");
                const printButton = currentTab.contentEl.querySelector(`#print-btn-${currentTab.id}`);
                if (printButton) { printButton.disabled = false; printButton.innerHTML = `<i data-lucide="printer" class="inline-block mr-2"></i>결과 인쇄하기`; safeCreateIcons(); }
            } catch (error) { console.error("Search failed:", error); showToast("콘텐츠 생성 중 오류가 발생했습니다.", "error"); hideLoader(); contentContainer.innerHTML = `<div class="card p-8 text-center text-red-500"><p>검색 결과를 불러오는 데 실패했습니다.</p><p class="text-sm text-gray-500 mt-2">존재하지 않는 단어이거나, 네트워크 문제일 수 있습니다.</p></div>`; }
            finally { searchButton.disabled = false; }
        }

        async function renderSavedPage(tab, pageData) {
            const contentContainer = tab.contentEl;
            contentContainer.innerHTML = '';
            
            try {
                renderDeletePageButton(contentContainer, pageData.initialData.word);

                renderBasicInfo(pageData.initialData, pageData.mainImageUrl, contentContainer);
                const mainImgEl = contentContainer.querySelector('#main-image');
                if (mainImgEl) {
                    mainImgEl.onclick = () => showImageAnalysisModal(pageData.mainImageUrl, pageData.initialData.word, pageData.initialData.koreanMeaning);
                }

                renderEpisode(pageData.initialData, pageData.episodeImageUrl, contentContainer);

                renderSavedMeanings(pageData.meaningsData, pageData.initialData.word, contentContainer);

                renderSentenceCrafter(pageData.initialData.word, contentContainer);

                const buttonContainer = renderDeepDiveButtonsContainer(contentContainer);
                if (pageData.fastDeepDiveData && pageData.fastDeepDiveData.conceptTree) {
                    appendConceptTreeButton(buttonContainer, pageData.fastDeepDiveData.conceptTree);
                }
                if (pageData.encyclopediaData && pageData.encyclopediaData.encyclopedia) {
                    appendEncyclopediaButton(buttonContainer, pageData.encyclopediaData.encyclopedia);
                }
                if (pageData.fastDeepDiveData) {
                    renderDeepDive(pageData.fastDeepDiveData, contentContainer);
                }
                
                showToast("저장된 페이지를 불러왔습니다.", "success");
                safeCreateIcons();
            } catch (error) {
                console.error("Error rendering saved page:", error);
                contentContainer.innerHTML = `<div class="card p-8 text-center text-red-500"><p>저장된 페이지를 불러오는 데 실패했습니다.</p></div>`;
            }
        }

        function renderSavePageButton(tab) {
            const saveButton = document.createElement('button');
            saveButton.id = `save-page-btn-${tab.id}`;
            saveButton.className = 'btn-3d mb-4 ml-4';
            saveButton.disabled = true; 
            saveButton.innerHTML = `<div class="loader w-5 h-5 border-2 border-t-blue-500 inline-block mr-2 animate-spin"></div>이미지 로딩 중...`;
            saveButton.onclick = () => saveCurrentPage(tab.id);
            const printButton = tab.contentEl.querySelector(`#print-btn-${tab.id}`);
            if (printButton) {
                printButton.insertAdjacentElement('afterend', saveButton);
            } else {
                tab.contentEl.prepend(saveButton);
            }
            safeCreateIcons();
        }

        function renderDeletePageButton(container, word, replaceButtonId = null) {
            const deleteButton = document.createElement('button');
            deleteButton.id = `delete-page-btn-${word}`;
            deleteButton.className = 'btn-3d mb-4 !bg-red-500 !text-white hover:!bg-red-600';
            deleteButton.innerHTML = `🗑️ 저장된 페이지 삭제`;
            deleteButton.onclick = () => deleteSavedPage(word);
            
            if (replaceButtonId) {
                const oldButton = document.getElementById(replaceButtonId);
                if (oldButton) {
                    oldButton.replaceWith(deleteButton);
                } else {
                    container.prepend(deleteButton);
                }
            } else {
                container.prepend(deleteButton);
            }
            safeCreateIcons();
        }

        // ---------------------------
        // Rendering Functions
        // ---------------------------
        function renderPrintButton(tab) { const printButton = document.createElement('button'); printButton.id = `print-btn-${tab.id}`; printButton.className = 'btn-3d mb-4'; printButton.disabled = true; printButton.innerHTML = `<div class="loader w-5 h-5 border-2 border-t-blue-500 inline-block mr-2 animate-spin"></div>인쇄 준비 중...`; printButton.onclick = () => handlePrint(tab.id); tab.contentEl.prepend(printButton); safeCreateIcons(); }
        window.renderBasicInfo = function(data, imageUrl, container) { const html = `<div class="card p-6"><div class="flex flex-col md:flex-row items-center gap-6"><div class="w-full md:w-2/5"><img id="main-image" src="${imageUrl}" alt="${data.word}" class="rounded-lg shadow-lg w-full h-auto object-cover clickable-image"></div><div class="w-full md:w-3/5"><div class="flex items-center gap-4 mb-4"><h2 class="text-5xl font-bold">${data.word}</h2><button onclick="speak('${data.word}', 'en-US')" class="btn-3d p-3">${createVolumeIcon()}</button><button id="pronunciation-btn" class="btn-3d p-3 text-purple-600" onclick="startPronunciationCheck('${data.word}')">✨ 발음 피드백</button></div><div class="flex items-center gap-2"><p class="text-2xl text-gray-600">${data.koreanMeaning}</p><button onclick="speak('${data.koreanMeaning}', 'ko-KR')" class="btn-3d p-3">${createVolumeIcon()}</button></div><p class="text-lg text-gray-500 mt-2">[${data.pronunciation}]</p><div id="pronunciation-feedback" class="mt-4 p-3 rounded-lg bg-yellow-100 text-yellow-700 hidden"></div></div></div></div>`; container.insertAdjacentHTML('beforeend', html); safeCreateIcons(); }
        window.renderEpisode = function(data, imageUrl, container) { const { episode, word } = data; const html = `<div class="card p-6"><h3 class="text-2xl font-bold mb-4 flex items-center"><i data-lucide="sparkles" class="mr-2 text-yellow-500"></i>재미있는 에피소드</h3><img id="episode-image" src="${imageUrl}" alt="Episode illustration" class="rounded-lg shadow-md w-full h-auto object-cover mb-4 max-w-sm mx-auto clickable-image"><div class="space-y-2"><p class="text-lg leading-relaxed">${addClickToSearch(episode.story)}</p><p class="text-md leading-relaxed text-gray-600">${episode.story_ko}</p></div><div class="mt-4 flex flex-col sm:flex-row gap-2"><button class="icon-btn" onclick="speak('${episode.story.replace(/'/g, "\\'")}', 'en-US')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">영어 듣기</span></button><button class="icon-btn" onclick="speak('${episode.story_ko.replace(/'/g, "\\'")}', 'ko-KR')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">한국어 듣기</span></button><button class="btn-3d flex-grow" onclick="expandStory(this, '${word}', '${episode.story.replace(/'/g, "\\'")}', '${episode.story_ko.replace(/'/g, "\\'")}')">✨ 이야기 더 만들기</button></div></div>`; container.insertAdjacentHTML('beforeend', html); safeCreateIcons(); }
        window.renderDeepDiveButtonsContainer = function(container) { const btnContainer = document.createElement('div'); btnContainer.id = 'deep-dive-buttons'; btnContainer.className = 'card p-6 grid grid-cols-1 sm:grid-cols-2 gap-4'; container.appendChild(btnContainer); return btnContainer; }
        window.appendConceptTreeButton = function(container, conceptTreeData) { const conceptTreeBtn = document.createElement('button'); conceptTreeBtn.id = 'concept-tree-btn'; conceptTreeBtn.className = 'btn-3d w-full'; conceptTreeBtn.textContent = '개념 트리 보기'; conceptTreeBtn.onclick = () => showConceptTree(conceptTreeData); container.appendChild(conceptTreeBtn); }
        window.appendEncyclopediaButton = function(container, encyclopediaData) { const encyclopediaBtn = document.createElement('button'); encyclopediaBtn.id = 'encyclopedia-btn'; encyclopediaBtn.className = 'btn-3d w-full'; encyclopediaBtn.textContent = '백과사전식 설명 보기'; encyclopediaBtn.onclick = () => showEncyclopedia(encyclopediaData); container.prepend(encyclopediaBtn); }

        window.renderMeanings = async function(meanings, word, searchId, currentTab, mainContainer) {
            const container = document.createElement('div'); container.className = 'card p-6 space-y-8'; container.innerHTML = `<h3 class="text-2xl font-bold mb-4 flex items-center"><i data-lucide="book-open-check" class="mr-2 text-green-600"></i>의미 분석</h3>`; mainContainer.appendChild(container);
            for (const [index, meaning] of meanings.entries()) {
                if (currentTab.searchId !== searchId) return;
                const element = document.createElement('div'); element.className = 'border-t border-slate-300 pt-6';
                const placeholderImg = "https://placehold.co/300x300/e0e5ec/4a5568?text=Loading...";
                element.innerHTML = `<h4 class="text-xl font-semibold text-blue-700">${meaning.type}</h4><img id="meaning-image-${index}" src="${placeholderImg}" alt="${meaning.type}" class="rounded-lg shadow-md w-full h-auto object-cover mb-4 max-w-sm mx-auto clickable-image"><p class="text-gray-600 my-2">${meaning.description}</p>`;
                container.appendChild(element); 
                
                const imgEl = element.querySelector(`#meaning-image-${index}`);
                const meaningImagePromise = new Promise((resolve, reject) => {
                    callImagenWithRetry(meaning.imagePrompt).then(imageResult => {
                        if (currentTab.searchId === searchId) {
                            if (currentTab.fullSearchResult.meaningsData?.[index]) { currentTab.fullSearchResult.meaningsData[index].imageUrl = imageResult.url; }
                            
                            imgEl.onload = () => resolve({ type: 'meaning', index, ...imageResult });
                            imgEl.onerror = () => reject(new Error(`Meaning image ${index} load fail`));
                            imgEl.src = imageResult.url;

                            if (imageResult.status === 'success') { imgEl.onclick = () => showImageModal(imageResult.url); }
                            else { imgEl.title = "이미지 생성에 실패했습니다."; imgEl.onclick = () => showToast("경고: 이미지 생성에 실패했습니다.", "error"); }
                        } else { reject(new Error('Tab changed')); }
                    }).catch(error => { console.error(`Failed to load image for meaning ${index}:`, error); imgEl.src = `https://placehold.co/300x300/e74c3c/ffffff?text=Image+Load+Failed`; reject(error); });
                });
                currentTab.imageLoadPromises.push(meaningImagePromise);
                
                const examplesPrompt = `영어 단어 "${word}"의 "${meaning.description}" 의미와 관련된, 현대적이고 유용한 영어 예문 5개와 각각의 한글 번역을 생성해줘. 다음 JSON 형식을 반드시 따라줘:\n[\n  {"en": "Example sentence 1.", "ko": "예문 1 한글 번역."},\n  {"en": "Example sentence 2.", "ko": "예문 2 한글 번역."}\n]`;
                const examples = await callGemini(examplesPrompt, true);
                if (currentTab.searchId !== searchId) return;
                if (currentTab.fullSearchResult.meaningsData?.[index]) { currentTab.fullSearchResult.meaningsData[index].examples = examples; }
                const examplesHtml = examples.map((ex, i) => `<li class="flex items-start justify-between gap-3 mt-2"><div class="flex items-start"><span class="text-gray-500 mr-2">${i + 1}.</span><div><p class="text-md font-medium">${addClickToSearch(ex.en)}</p><p class="text-sm text-gray-500">${ex.ko}</p></div></div><div class="flex items-center flex-shrink-0 gap-1"><button class="icon-btn" onclick="speak('${ex.en.replace(/'/g, "\\'")}', 'en-US')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">영어 듣기</span></button><button class="icon-btn" onclick="speak('${ex.ko.replace(/'/g, "\\'")}', 'ko-KR')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">한국어 듣기</span></button><button class="icon-btn" onclick="saveSentence('${ex.en.replace(/'/g, "\\'")}', '${ex.ko.replace(/'/g, "\\'")}')">${createSaveIcon('w-5 h-5')}<span class="tooltip">저장하기</span></button></div></li>`).join('');
                element.innerHTML += `<p class="font-medium mt-4 mb-2">대표 예문:</p><div class="bg-slate-200 p-4 rounded-lg"><div><p class="text-lg font-semibold">${addClickToSearch(meaning.exampleSentence)}</p><p class="text-md text-gray-600">${meaning.exampleSentenceTranslation}</p></div><div class="flex items-center gap-2 mt-2"><button class="icon-btn" onclick="speak('${meaning.exampleSentence.replace(/'/g, "\\'")}', 'en-US')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">영어 듣기</span></button><button class="icon-btn" onclick="speak('${meaning.exampleSentenceTranslation.replace(/'/g, "\\'")}', 'ko-KR')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">한국어 듣기</span></button><button class="icon-btn" onclick="saveSentence('${meaning.exampleSentence.replace(/'/g, "\\'")}', '${meaning.exampleSentenceTranslation.replace(/'/g, "\\'")}')">${createSaveIcon('w-5 h-5')}<span class="tooltip">저장하기</span></button></div></div><p class="font-medium mt-4 mb-2">추가 예문:</p><ul class="list-inside space-y-2">${examplesHtml}</ul>`;
            }
            safeCreateIcons();
        }

        window.renderSavedMeanings = function(meanings, word, container) {
            const section = document.createElement('div');
            section.className = 'card p-6 space-y-8';
            section.innerHTML = `<h3 class="text-2xl font-bold mb-4 flex items-center"><i data-lucide="book-open-check" class="mr-2 text-green-600"></i>의미 분석</h3>`;
            container.appendChild(section);

            meanings.forEach((meaning, index) => {
                 const element = document.createElement('div'); 
                 element.className = 'border-t border-slate-300 pt-6';
                 
                 let examplesHtml = '';
                 if (meaning.examples && Array.isArray(meaning.examples)) {
                     examplesHtml = meaning.examples.map((ex, i) => `<li class="flex items-start justify-between gap-3 mt-2"><div class="flex items-start"><span class="text-gray-500 mr-2">${i + 1}.</span><div><p class="text-md font-medium">${addClickToSearch(ex.en)}</p><p class="text-sm text-gray-500">${ex.ko}</p></div></div><div class="flex items-center flex-shrink-0 gap-1"><button class="icon-btn" onclick="speak('${ex.en.replace(/'/g, "\\'")}', 'en-US')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">영어 듣기</span></button><button class="icon-btn" onclick="speak('${ex.ko.replace(/'/g, "\\'")}', 'ko-KR')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">한국어 듣기</span></button><button class="icon-btn" onclick="saveSentence('${ex.en.replace(/'/g, "\\'")}', '${ex.ko.replace(/'/g, "\\'")}')">${createSaveIcon('w-5 h-5')}<span class="tooltip">저장하기</span></button></div></li>`).join('');
                 }

                 element.innerHTML = `
                    <h4 class="text-xl font-semibold text-blue-700">${meaning.type}</h4>
                    <img src="${meaning.imageUrl || 'https://placehold.co/300x300/e0e5ec/4a5568?text=No+Image'}" alt="${meaning.type}" class="rounded-lg shadow-md w-full h-auto object-cover mb-4 max-w-sm mx-auto clickable-image" onclick="showImageModal(this.src)">
                    <p class="text-gray-600 my-2">${meaning.description}</p>
                    <p class="font-medium mt-4 mb-2">대표 예문:</p>
                    <div class="bg-slate-200 p-4 rounded-lg">
                        <div><p class="text-lg font-semibold">${addClickToSearch(meaning.exampleSentence)}</p><p class="text-md text-gray-600">${meaning.exampleSentenceTranslation}</p></div>
                        <div class="flex items-center gap-2 mt-2"><button class="icon-btn" onclick="speak('${meaning.exampleSentence.replace(/'/g, "\\'")}', 'en-US')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">영어 듣기</span></button><button class="icon-btn" onclick="speak('${meaning.exampleSentenceTranslation.replace(/'/g, "\\'")}', 'ko-KR')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">한국어 듣기</span></button><button class="icon-btn" onclick="saveSentence('${meaning.exampleSentence.replace(/'/g, "\\'")}', '${meaning.exampleSentenceTranslation.replace(/'/g, "\\'")}')">${createSaveIcon('w-5 h-5')}<span class="tooltip">저장하기</span></button></div>
                    </div>
                    <p class="font-medium mt-4 mb-2">추가 예문:</p>
                    <ul class="list-inside space-y-2">${examplesHtml}</ul>
                 `;
                 section.appendChild(element);
            });
            safeCreateIcons();
        }

        window.renderSentenceCrafter = function(word, container) { const html = `<div class="card p-6"><h3 class="text-2xl font-bold mb-4 flex items-center"><i data-lucide="sparkles" class="mr-2 text-blue-500"></i>AI 문장 만들기 ✨</h3><p class="text-gray-600 mb-4">단어를 사용하고 싶은 상황을 입력하면 AI가 맞춤 예문을 만들어 드립니다. (예: 회의, 친구와의 대화, 이메일 작성)</p><div class="flex flex-col sm:flex-row gap-4"><input type="text" id="sentence-context-input" placeholder="상황을 입력하세요..." class="w-full px-4 py-3 text-lg border-2 border-slate-300 bg-slate-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"><button id="sentence-craft-button" class="btn-3d w-full sm:w-auto" onclick="craftSentences(this, '${word}')"><i data-lucide="pencil-ruler" class="inline-block mr-2"></i> 생성</button></div><div id="sentence-crafter-results" class="mt-4"></div></div>`; container.insertAdjacentHTML('beforeend', html); safeCreateIcons(); }
        window.renderDeepDive = function(data, container) { const html = `<div class="card p-6"><h3 class="text-2xl font-bold mb-4 flex items-center"><i data-lucide="graduation-cap" class="mr-2 text-purple-600"></i>심화 학습</h3><div class="space-y-6">${renderSection("관련 명언/문구", "quote", data.quotes.map(q => `<div class="border-l-4 border-slate-400 pl-4 py-2"><p class="font-semibold text-lg">${addClickToSearch(q.quote)}</p><p class="text-gray-600">${q.translation}</p><div class="mt-2 flex gap-2"><button class="icon-btn" onclick="speak('${q.quote.replace(/'/g, "\\'")}', 'en-US')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">영어 듣기</span></button><button class="icon-btn" onclick="speak('${q.translation.replace(/'/g, "\\'")}', 'ko-KR')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">한국어 듣기</span></button><button class="icon-btn" onclick="saveSentence('${q.quote.replace(/'/g, "\\'")}', '${q.translation.replace(/'/g, "\\'")}')">${createSaveIcon('w-5 h-5')}<span class="tooltip">저장하기</span></button></div></div>`).join('<hr class="my-3 border-slate-300">'))}${renderSection("유의어 및 반의어", "arrow-right-left", `<div><h5 class="font-semibold">유의어:</h5><div class="flex flex-wrap gap-2 mt-2">${data.synonyms.map(s => `<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full clickable-word">${s}</span>`).join('')}</div></div><div class="mt-4"><h5 class="font-semibold">반의어:</h5><div class="flex flex-wrap gap-2 mt-2">${data.antonyms.map(a => `<span class="bg-red-100 text-red-800 px-3 py-1 rounded-full clickable-word">${a}</span>`).join('')}</div></div>`)}${renderSection("AI 시나리오 학습", "message-circle", `<div class="bg-slate-200 p-4 rounded-lg space-y-3">${data.dialogue.map(d => `<div class="border-b border-slate-300 pb-2 mb-2 last:border-b-0 last:pb-0 last:mb-0"><div class="flex justify-between items-start gap-2"><div class="flex-grow"><p><span class="font-bold text-blue-600">${d.speaker}:</span> ${addClickToSearch(d.line)}</p><p class="text-sm text-gray-500 pl-4">${d.translation}</p></div><div class="flex items-center flex-shrink-0 gap-1 mt-1"><button class="icon-btn" onclick="speak('${d.line.replace(/'/g, "\\'")}', 'en-US')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">영어 듣기</span></button><button class="icon-btn" onclick="speak('${d.translation.replace(/'/g, "\\'")}', 'ko-KR')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">한국어 듣기</span></button><button class="icon-btn" onclick="saveSentence('${d.line.replace(/'/g, "\\'")}', '${d.translation.replace(/'/g, "\\'")}')">${createSaveIcon('w-5 h-5')}<span class="tooltip">저장하기</span></button></div></div></div>`).join('')}</div>`)}${renderQuiz("4지선다 퀴즈", "swords", data.quiz)}</div></div>`; container.insertAdjacentHTML('beforeend', html); safeCreateIcons(); }
        window.renderSection = function(title, icon, content) { return `<div class="border-t border-slate-300 pt-4"><h4 class="text-xl font-semibold mb-3 flex items-center"><i data-lucide="${icon}" class="w-5 h-5 mr-2"></i>${title}</h4><div>${content}</div></div>`; }
        window.renderQuiz = function(title, icon, quizData) { const quizContent = quizData.map((q, index) => { const optionsHtml = q.options.map(option => `<label class="block"><input type="radio" name="quiz-${index}" value="${option}" class="mr-2">${option}</label>`).join(''); return `<div class="mt-4 bg-slate-200 p-4 rounded-lg" id="quiz-container-${index}"><p class="font-semibold">${index + 1}. ${q.question}</p><div class="my-2 space-y-1">${optionsHtml}</div><button onclick="checkQuizAnswer(this, ${index}, '${q.answer.replace(/'/g, "\\'")}')" class="text-sm bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600 quiz-button">정답 확인</button><div id="quiz-explanation-${index}" class="hidden mt-2 p-2 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700"><p><strong class="font-bold">정답: ${q.answer}</strong></p><p>${q.explanation}</p></div></div>`; }).join(''); return renderSection(title, icon, quizContent); }

        // ---------------------------
        // UI/UX Utility Functions
        // ---------------------------
        function createVolumeIcon(size = 'w-5 h-5') { return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-blue-500"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>`; }
        function createSaveIcon(size = 'w-5 h-5') { return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-green-600"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>`; }
        window.checkQuizAnswer = function(button, index, correctAnswer) { const container = button.closest(`#quiz-container-${index}`); const selected = container.querySelector(`input[name="quiz-${index}"]:checked`); if (!selected) { showToast("답을 선택해주세요.", "warning"); return; } if (selected.value === correctAnswer) { selected.parentElement.classList.add('text-green-600', 'font-bold'); showToast("정답입니다!", "success"); } else { selected.parentElement.classList.add('text-red-600', 'font-bold'); showToast("오답입니다. 다시 생각해보세요.", "error"); } container.querySelector(`#quiz-explanation-${index}`).classList.remove('hidden'); }
        function showLoader(progress, text) { loadingContainer.classList.remove('hidden'); progressBar.style.width = `${progress}%`; loadingText.textContent = text; }
        function updateLoader(progress, text) { progressBar.style.width = `${progress}%`; loadingText.textContent = text; }
        function hideLoader() { loadingContainer.classList.add('hidden'); }
        function addClickToSearch(text) { if(!text) return ''; return text.replace(/\b[a-zA-Z]{2,}\b/g, (match) => `<span class="clickable-word">${match}</span>`); }
        window.speak = function(text, lang = 'en-US') { if (!('speechSynthesis' in window)) { showToast("현재 브라우저에서는 음성 출력을 지원하지 않습니다.", "warning"); return; } if (!text) return; speechSynthesis.cancel(); const utterance = new SpeechSynthesisUtterance(text); utterance.lang = lang; speechSynthesis.speak(utterance); }
        window.startPronunciationCheck = function(word) { const feedbackDiv = document.getElementById('pronunciation-feedback'); feedbackDiv.classList.add('hidden'); const message = `🎤 "${word}" 발음 녹음을 준비합니다. (실제 기능에서는 Gemini TTS API를 사용합니다.)`; showToast(message, 'info'); setTimeout(async () => { const prompt = `Act as an English teacher. Evaluate the pronunciation of the word "${word}" based on a typical non-native Korean speaker attempting to say it. Give encouraging but specific feedback. Format as a short paragraph in Korean.`; try { const feedbackText = await callGemini(prompt); feedbackDiv.innerHTML = `<i data-lucide="mic-vocal" class="inline-block mr-2 text-purple-600"></i><strong class="text-purple-700">AI 발음 피드백:</strong> ${feedbackText}`; feedbackDiv.classList.remove('hidden'); safeCreateIcons(); } catch (e) { feedbackDiv.innerHTML = `<i data-lucide="x-circle" class="inline-block mr-2 text-red-600"></i><strong class="text-red-700">AI 발음 피드백:</strong> 피드백 생성에 실패했습니다.`; feedbackDiv.classList.remove('hidden'); safeCreateIcons(); } }, 5000); }

        // ---------------------------
        // Modal and Tooltip Functions
        // ---------------------------

        window.showImageAnalysisModal = async function(src, word, meaning) { 
            modalContent.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-bold">이미지 분석: ${word}</h3><button onclick="hideModal()" class="text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button></div><img src="${src}" alt="${word}" class="rounded-lg shadow-md w-full h-auto object-cover mb-6"><div id="image-analysis-result" class="p-4 bg-slate-200 rounded-lg"><p class="font-semibold text-gray-700 flex items-center"><div class="loader w-4 h-4 border-2 border-t-blue-500 inline-block mr-2 animate-spin"></div>AI가 이미지를 분석 중입니다...</p></div>`; 
            modalContainer.classList.remove('hidden'); 
            modalContainer.classList.add('flex'); 
            safeCreateIcons(); 
            
            const activeTab = tabs[activeTabId];
            const savedAnalysisText = activeTab?.fullSearchResult?.mainImageAnalysisText;

            if (savedAnalysisText) {
                document.getElementById('image-analysis-result').innerHTML = `<strong class="text-blue-700">AI 분석 (저장됨):</strong> ${savedAnalysisText}`;
                return; 
            }

            try {
                // Since we are now using Google generated images (Data URLs or direct URLs), we can just pass them.
                // If it's a data URL, we send it directly.
                const prompt = `Analyze this image which was generated to represent the word "${word}" (meaning: ${meaning}). Describe how the visual elements in the image conceptually represent the word. Respond in Korean.`;
                
                // Directly call Gemini with the src (which is likely a base64 data url from our new generator)
                callGemini(prompt, false, src).then(analysis => { 
                    document.getElementById('image-analysis-result').innerHTML = `<strong class="text-blue-700">AI 분석:</strong> ${analysis}`;
                    if (activeTab?.fullSearchResult) {
                        activeTab.fullSearchResult.mainImageAnalysisText = analysis;
                    }

                }).catch(e => { 
                    console.error("Gemini analysis failed:", e);
                    document.getElementById('image-analysis-result').innerHTML = `<strong class="text-red-600">분석 실패:</strong> AI가 이미지를 분석할 수 없습니다. (Gemini 오류)`; 
                });
            } catch (error) {
                console.error("Image analysis prep failed:", error);
                document.getElementById('image-analysis-result').innerHTML = `<strong class="text-red-600">분석 실패:</strong> 이미지 소스를 처리할 수 없습니다. (${error.message})`;
            }
        }


        window.showImageModal = function(src) { modalImage.src = src; imageModalContainer.classList.remove('hidden'); imageModalContainer.classList.add('flex'); safeCreateIcons(); }
        window.hideImageModal = function() { imageModalContainer.classList.add('hidden'); imageModalContainer.classList.remove('flex'); modalImage.src = ''; }
        function renderEncyclopediaSection(title, content_en, content_ko) { const safe_content_en = content_en || ''; const safe_content_ko = content_ko || ''; if (!safe_content_en && !safe_content_ko) return ''; return `<div class="mt-6"><h4 class="text-xl font-bold mb-2">${title}</h4><div class="prose max-w-none text-justify space-y-4"><p class="text-gray-700">${safe_content_ko.replace(/\n/g, '<br>')}</p><details class="text-sm"><summary class="cursor-pointer text-gray-500">영어 원문 보기</summary><p class="mt-2 text-gray-600">${addClickToSearch(safe_content_en.replace(/\n/g, '<br>'))}</p></details></div></div>`; }
        function getEncyclopediaHtml(data) { return `<div class="print-section"><h3 class="text-2xl font-bold mb-4">백과사전식 심화 설명</h3>${renderEncyclopediaSection('서론 (Introduction)', data.introduction, data.introduction_ko)}${renderEncyclopediaSection('어원 (Etymology)', data.etymology, data.etymology_ko)}${renderEncyclopediaSection('역사적 배경 (Historical Background)', data.history, data.history_ko)}${renderEncyclopediaSection('문학/현대에서의 사용 (Usage)', data.usage, data.usage_ko)}</div>`; }
        function showEncyclopedia(data) { modalContent.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-bold">백과사전식 설명</h3><button onclick="hideModal()" class="text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button></div><div id="encyclopedia-content">${renderEncyclopediaSection('서론 (Introduction)', data.introduction, data.introduction_ko)}${renderEncyclopediaSection('어원 (Etymology)', data.etymology, data.etymology_ko)}${renderEncyclopediaSection('역사적 배경 (Historical Background)', data.history, data.history_ko)}${renderEncyclopediaSection('문학/현대에서의 사용 (Usage)', data.usage, data.usage_ko)}</div>`; modalContainer.classList.remove('hidden'); modalContainer.classList.add('flex'); safeCreateIcons(); }
        function getConceptTreeHtml(data) { const createList = (title, items) => { if (!items || items.length === 0) return ''; const itemsHtml = items.map(item => `<span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full">${item}</span>`).join(''); return `<div><h4 class="font-semibold text-lg mt-4">${title}</h4><div class="flex flex-wrap gap-2 mt-2">${itemsHtml}</div></div>` }; return `<div class="print-section mt-8"><h3 class="text-2xl font-bold mb-4">개념 트리</h3>${createList('상위 개념', data.superordinate)}${createList('동위 개념', data.coordinate)}${createList('하위 개념', data.subordinate)}</div>`; }
        function showConceptTree(data) { const createList = (title, items) => { if (!items || items.length === 0) return ''; return `<div><h4 class="font-semibold text-lg mt-4">${title}</h4><div class="flex flex-wrap gap-2 mt-2">${items.map(item => `<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full clickable-word">${item}</span>`).join('')}</div></div>` }; modalContent.innerHTML = `<div class="flex justify-between items-center mb-4"><h3 class="text-2xl font-bold">개념 트리</h3><button onclick="hideModal()" class="text-gray-500 hover:text-gray-800"><i data-lucide="x"></i></button></div><div id="concept-tree-content">${createList('상위 개념', data.superordinate)}${createList('동위 개념', data.coordinate)}${createList('하위 개념', data.subordinate)}</div>`; modalContainer.classList.remove('hidden'); modalContainer.classList.add('flex'); safeCreateIcons(); }
        window.hideModal = function(event) { if (event && event.currentTarget !== event.target) return; modalContainer.classList.add('hidden'); modalContainer.classList.remove('flex'); }
        window.showFileModal = function() { fileModalContainer.classList.remove('hidden'); fileModalContainer.classList.add('flex'); }
        window.hideFileModal = function(event) { if (event && event.currentTarget !== event.target && !event.target.closest('button')) return; fileModalContainer.classList.add('hidden'); fileModalContainer.classList.remove('flex'); }
        function showConfirmationModal(message, onConfirm) { confirmationMessage.textContent = message; confirmCallback = onConfirm; confirmationModal.classList.remove('hidden'); confirmationModal.classList.add('flex'); }
        function hideConfirmationModal() { confirmationModal.classList.add('hidden'); confirmationModal.classList.remove('flex'); confirmCallback = null; }

        // 6. Firestore Data Management
        window.saveCurrentPage = async function(tabId) {
            const tab = tabs[tabId];
            if (!tab || !tab.fullSearchResult) {
                showToast("저장할 데이터가 없습니다.", "error");
                return;
            }
            const saveButton = document.getElementById(`save-page-btn-${tabId}`);
            saveButton.disabled = true;
            saveButton.innerHTML = `<div class="loader w-5 h-5 border-2 border-t-blue-500 inline-block mr-2 animate-spin"></div>0%...`;

            try {
                const word = tab.fullSearchResult.initialData.word.toLowerCase();
                
                if (!userId) {
                    showToast("로그인이 필요합니다.", "error");
                    saveButton.disabled = false;
                    saveButton.innerHTML = `💾 이 페이지 저장하기`;
                    return;
                }
                const pageData = JSON.parse(JSON.stringify(tab.fullSearchResult)); 
                const imageUploads = [];

                if (pageData.mainImageUrl && pageData.mainImageUrl.startsWith('data:image')) {
                    imageUploads.push(
                        uploadBase64Image(pageData.mainImageUrl, `saved_pages/${userId}/${word}/main.png`)
                            .then(url => pageData.mainImageUrl = url)
                    );
                }
                if (pageData.episodeImageUrl && pageData.episodeImageUrl.startsWith('data:image')) {
                    imageUploads.push(
                        uploadBase64Image(pageData.episodeImageUrl, `saved_pages/${userId}/${word}/episode.png`)
                            .then(url => pageData.episodeImageUrl = url)
                    );
                }
                if (pageData.meaningsData) {
                    pageData.meaningsData.forEach((meaning, index) => {
                        if (meaning.imageUrl && meaning.imageUrl.startsWith('data:image')) {
                            imageUploads.push(
                                uploadBase64Image(meaning.imageUrl, `saved_pages/${userId}/${word}/meaning_${index}.png`)
                                    .then(url => pageData.meaningsData[index].imageUrl = url)
                            );
                        }
                    });
                }

                if (imageUploads.length === 0) {
                    saveButton.innerHTML = `<div class="loader w-5 h-5 border-2 border-t-blue-500 inline-block mr-2 animate-spin"></div>Firestore 저장 중...`;
                }

                let completedUploads = 0;
                imageUploads.forEach(promise => {
                    promise.then(() => {
                        completedUploads++;
                        const progress = Math.round((completedUploads / imageUploads.length) * 100);
                        saveButton.innerHTML = `<div class="loader w-5 h-5 border-2 border-t-blue-500 inline-block mr-2 animate-spin"></div>${progress}%...`;
                    }).catch(err => {
                        console.error("Image upload failed in promise:", err);
                    });
                });

                await Promise.all(imageUploads.map(p => p.catch(e => e))); 

                saveButton.innerHTML = `<div class="loader w-5 h-5 border-2 border-t-blue-500 inline-block mr-2 animate-spin"></div>Firestore 저장 중...`;
                const pageRef = doc(db, `artifacts/${appId}/users/${userId}/saved_pages/${word}`);
                await setDoc(pageRef, {
                    word: word,
                    savedAt: new Date(),
                    pageData: pageData 
                });

                showToast("페이지가 성공적으로 저장되었습니다!", "success");
                renderDeletePageButton(tab.contentEl, word, `save-page-btn-${tabId}`);
            } catch (error) {
                console.error("Error saving page:", error);
                showToast("페이지 저장에 실패했습니다.", "error");
                saveButton.disabled = false;
                saveButton.innerHTML = `💾 이 페이지 저장하기`;
            }
        }

        window.deleteSavedPage = async function(word) {
            const normalizedWord = word.toLowerCase();
            showConfirmationModal(`'${normalizedWord}'의 저장된 페이지를 정말로 삭제하시겠습니까? (저장된 이미지 파일은 삭제되지 않습니다)`, async () => {
                if (!db || !userId) {
                    showToast("DB 연결 오류", "error");
                    return;
                }
                const pageRef = doc(db, `artifacts/${appId}/users/${userId}/saved_pages/${normalizedWord}`);
                try {
                    await deleteDoc(pageRef);
                    showToast("저장된 페이지를 삭제했습니다.", "success");
                    
                    const deleteButton = document.getElementById(`delete-page-btn-${normalizedWord}`);
                    if(deleteButton) {
                        const tabId = deleteButton.closest('[id^="tab-content-"]').id.replace('tab-content-', 'tab-');
                        const saveButton = document.createElement('button');
                        saveButton.id = `save-page-btn-${tabId}`;
                        saveButton.className = 'btn-3d mb-4 ml-4';
                        saveButton.disabled = false; 
                        saveButton.innerHTML = `💾 이 페이지 저장하기`;
                        saveButton.onclick = () => saveCurrentPage(tabId);
                        deleteButton.replaceWith(saveButton);
                        safeCreateIcons();
                    }
                } catch (error) {
                    console.error("Error deleting saved page:", error);
                    showToast("삭제에 실패했습니다.", "error");
                }
            });
        }

        async function addWordToHistory(word, meaning) { 
            if (!db || !userId) return; 
            const normalizedWord = word.toLowerCase();
            const wordRef = doc(db, `artifacts/${appId}/users/${userId}/saved_words/${normalizedWord}`); 
            try { 
                await setDoc(wordRef, { word: normalizedWord, meaning, timestamp: new Date(), read: false }, { merge: true }); 
            } catch(e){ console.error("Error adding word to history: ", e); } 
        }
        window.saveSentence = async function(en, ko) { if (!db || !userId) { showToast("데이터베이스에 연결되지 않았습니다.", "error"); return; } try { const sentenceRef = collection(db, `artifacts/${appId}/users/${userId}/saved_sentences`); await addDoc(sentenceRef, { en, ko, timestamp: new Date(), read: false }); showToast("예문이 저장되었습니다.", "success"); } catch (e) { console.error("Error saving sentence: ", e); showToast("예문 저장에 실패했습니다.", "error"); } }

        // 7. Saved List Modal UI
        let currentListType = ''; let currentSort = 'newest';
        function showListModal(type) { currentListType = type; listModalContainer.classList.remove('hidden'); listModalContainer.classList.add('flex'); if (type === 'words') { listModalTitle.textContent = '단어 목록 (검색 기록)'; sortOptions.innerHTML = `<option value="newest">최신순</option><option value="alphabetical">알파벳순</option>`; } else { listModalTitle.textContent = '저장된 예문 목록'; sortOptions.innerHTML = `<option value="newest">최신순</option><option value="length">길이순</option>`; } sortOptions.value = currentSort; renderList(); updateListActionButtonsState(); }

        function renderList() { 
            let items = currentListType === 'words' ? [...savedWords] : [...savedSentences]; 
            items.sort((a, b) => { 
                if (!a.timestamp || !b.timestamp) return 0; 
                const timeA = a.timestamp.toMillis ? a.timestamp.toMillis() : new Date(a.timestamp).getTime(); 
                const timeB = b.timestamp.toMillis ? b.timestamp.toMillis() : new Date(b.timestamp).getTime(); 
                return timeB - timeA; 
            }); 
            
            if (currentSort === 'alphabetical' && currentListType === 'words') { 
                items.sort((a, b) => a.word.localeCompare(b.word)); 
            } else if (currentSort === 'length' && currentListType === 'sentences') { 
                items.sort((a, b) => a.en.length - b.en.length); 
            } 
            
            if (items.length === 0) { 
                listModalContent.innerHTML = `<p class="text-center text-gray-500">저장된 항목이 없습니다.</p>`; 
                return; 
            } 
            
            listModalContent.innerHTML = items.map(item => { 
                const readClass = item.read ? 'opacity-50' : ''; 
                
                const baseHtml = `<div class="flex items-center justify-between p-3 rounded-lg hover:bg-slate-200 ${readClass}" data-id="${item.id}"><div class="flex items-center flex-grow"><input type="checkbox" class="mr-4 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 item-checkbox" data-id="${item.id}"><div class="flex-grow">`; 
                
                if (currentListType === 'words') { 
                    return baseHtml + `<p class="font-bold text-lg" data-word="${item.word}">${item.word}</p><p class="truncate">${item.meaning}</p></div></div>
                        <div class="flex items-center gap-1 flex-shrink-0">
                            <button onclick="loadWordFromList('${item.word.replace(/'/g, "\\'")}', true)" class="icon-btn">${createLoadIcon()}<span class="tooltip">저장된 페이지 로드</span></button>
                            <button onclick="loadWordFromList('${item.word.replace(/'/g, "\\'")}', false)" class="icon-btn">${createSearchIcon()}<span class="tooltip">새로 검색</span></button>
                            <button onclick="toggleReadStatus('${item.id}', 'words')" class="icon-btn">${item.read ? createEyeOffIcon() : createEyeIcon()} <span class="tooltip">${item.read ? '읽지 않음으로' : '읽음으로'}</span></button>
                            <button onclick="deleteListItem('${item.id}', 'words')" class="icon-btn text-red-500 hover:bg-red-100">${createTrashIcon()}<span class="tooltip">삭제</span></button>
                        </div></div>`; 
                } else { 
                    return baseHtml + `<div><p class="font-semibold">${addClickToSearch(item.en)}</p><p class="text-sm">${item.ko}</p></div></div></div><div class="flex items-center gap-1 flex-shrink-0"><button class="icon-btn" onclick="speak('${item.en.replace(/'/g, "\\'")}', 'en-US')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">영어 듣기</span></button><button onclick="toggleReadStatus('${item.id}', 'sentences')" class="icon-btn">${item.read ? createEyeOffIcon() : createEyeIcon()}<span class="tooltip">${item.read ? '읽지 않음으로' : '읽음으로'}</span></button><button onclick="deleteListItem('${item.id}', 'sentences')" class="icon-btn text-red-500 hover:bg-red-100">${createTrashIcon()}<span class="tooltip">삭제</span></button></div></div>`; 
                } 
            }).join('<hr class="my-1 border-slate-300">'); 
            
            safeCreateIcons(); 
        } 
        window.renderList = renderList;


        function createEyeIcon(size = 'w-5 h-5') { return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-gray-500"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>`; } function createEyeOffIcon(size = 'w-5 h-5') { return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-gray-500"><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"></path><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"></path><path d="M6.61 6.61A13.16 13.16 0 0 0 2 12s3 7 10 7a9.92 9.92 0 0 0 5.43-1.61"></path><line x1="2" x2="22" y1="2" y2="22"></line></svg>`; } function createTrashIcon(size = 'w-5 h-5') { return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-red-500"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M10 11v6"></path><path d="M14 11v6"></path><path d="M15 6V4c0-1-1-2-2-2h-2c-1 0-2 1-2 2v2"></path></svg>`; }
        function createLoadIcon(size = 'w-5 h-5') { 
            return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-blue-600"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>`; 
        }
        function createSearchIcon(size = 'w-5 h-5') { 
            return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-green-600"><circle cx="11" cy="11" r="8"></circle><line x1="21" x2="16.65" y1="21" y2="16.65"></line></svg>`; 
        }
        window.loadWordFromList = function(word, fromSaved) {
            searchInput.value = word;
            if (fromSaved) {
                checkAndLoadPage(word); 
            } else {
                executeSearchForWord(word);
            }
            hideListModal(); 
        }

        window.deleteListItem = function(id, type) { 
            const normalizedId = type === 'words' ? id.toLowerCase() : id;
            showConfirmationModal("정말로 이 항목을 삭제하시겠습니까?", async () => { 
                if (!db || !userId) return; 
                const collectionName = type === 'words' ? 'saved_words' : 'saved_sentences'; 
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionName}/${normalizedId}`); 
                try { 
                    await deleteDoc(docRef); 
                    showToast("삭제되었습니다.", "success"); 
                } catch (error) { 
                    console.error("Error deleting item:", error); 
                    showToast("삭제에 실패했습니다.", "error"); 
                } 
            }); 
        }
        window.toggleReadStatus = async function(id, type) { 
            if (!db || !userId) return; 
            const normalizedId = type === 'words' ? id.toLowerCase() : id;
            const collectionName = type === 'words' ? 'saved_words' : 'saved_sentences'; 
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionName}/${normalizedId}`); 
            try { 
                const docSnap = await getDoc(docRef); 
                if (docSnap.exists()) { 
                    const currentStatus = docSnap.data().read; 
                    await updateDoc(docRef, { read: !currentStatus }); 
                } 
            } catch (error) { 
                console.error("Error toggling read status:", error); 
                showToast("상태 변경에 실패했습니다.", "error"); 
            } 
        };
        function updateListActionButtonsState() { const checkedItems = listModalContent.querySelectorAll('.item-checkbox:checked'); const hasSelection = checkedItems.length > 0; markReadBtn.disabled = !hasSelection; markUnreadBtn.disabled = !hasSelection; deleteSelectedBtn.disabled = !hasSelection; }
        async function performBulkAction(action) { const checkedItems = listModalContent.querySelectorAll('.item-checkbox:checked'); if (checkedItems.length === 0) { showToast("항목을 선택해주세요.", "warning"); return; } const actionText = action === 'delete' ? '삭제' : '상태 변경'; showConfirmationModal(`선택한 ${checkedItems.length}개 항목을 정말로 ${actionText}하시겠습니까?`, async () => { if (!db || !userId) return; const batch = writeBatch(db); const collectionName = currentListType === 'words' ? 'saved_words' : 'saved_sentences'; checkedItems.forEach(item => { 
            const normalizedId = currentListType === 'words' ? item.dataset.id.toLowerCase() : item.dataset.id;
            const docRef = doc(db, `artifacts/${appId}/users/${userId}/${collectionName}/${normalizedId}`); 
            if (action === 'delete') { batch.delete(docRef); } else { batch.update(docRef, { read: action === 'mark-read' }); } }); try { await batch.commit(); showToast("선택한 항목들이 처리되었습니다.", "success"); } catch (error) { console.error("Bulk action failed:", error); showToast("작업에 실패했습니다.", "error"); } }); }
        window.hideListModal = function(event) { if(event) { if (event.currentTarget !== event.target && !event.target.closest('button')) return; } listModalContainer.classList.add('hidden'); listModalContainer.classList.remove('flex'); }

        // 8. Tab & Print Management (No changes needed)
        function addTab(query, makeActive = true) { const tabId = `tab-${++tabCounter}`; const tabBar = document.getElementById('tab-bar'); const tabContentContainer = document.getElementById('tab-content-container'); const tabButton = document.createElement('button'); tabButton.id = `tab-btn-${tabId}`; tabButton.className = 'px-4 py-2 -mb-px border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-400 flex items-center'; tabButton.dataset.tabId = tabId; tabButton.innerHTML = `<span class="tab-title">${query.length > 10 ? query.substring(0, 10) + '...' : query}</span><span class="close-tab-btn ml-2 hover:bg-red-200 rounded-full w-4 h-4 flex items-center justify-center text-xs font-bold">&times;</span>`; tabBar.appendChild(tabButton); const tabContent = document.createElement('div'); tabContent.id = `tab-content-${tabId}`; tabContent.className = 'space-y-8'; tabContentContainer.appendChild(tabContent); tabs[tabId] = { id: tabId, query, contentEl: tabContent, buttonEl: tabButton, searchId: 0, fullSearchResult: null, imageLoadPromises: [] }; tabButton.addEventListener('click', () => switchTab(tabId)); tabButton.querySelector('.close-tab-btn').addEventListener('click', (e) => { e.stopPropagation(); closeTab(tabId); }); if (makeActive) { switchTab(tabId); } return tabId; }
        function switchTab(tabId) { if (!tabs[tabId]) return; activeTabId = tabId; for (const id in tabs) { tabs[id].buttonEl.classList.remove('border-blue-500', 'text-gray-900', 'font-semibold'); tabs[id].buttonEl.classList.add('border-transparent', 'text-gray-500'); tabs[id].contentEl.classList.add('hidden'); } tabs[tabId].buttonEl.classList.add('border-blue-500', 'text-gray-900', 'font-semibold'); tabs[tabId].buttonEl.classList.remove('border-transparent', 'text-gray-500'); tabs[tabId].contentEl.classList.remove('hidden'); }
        function closeTab(tabId) { if (!tabs[tabId]) return; tabs[tabId].buttonEl.remove(); tabs[tabId].contentEl.remove(); delete tabs[tabId]; if (activeTabId === tabId) { const remainingTabIds = Object.keys(tabs); if (remainingTabIds.length > 0) { switchTab(remainingTabIds[remainingTabIds.length - 1]); } else { activeTabId = null; } } }
        function handlePrint(tabId) { const tab = tabs[tabId]; if (!tab || !tab.fullSearchResult || !tab.fullSearchResult.encyclopediaData || !tab.fullSearchResult.fastDeepDiveData) { showToast("인쇄 데이터가 아직 준비되지 않았습니다. 모든 정보가 로딩될 때까지 기다려주세요.", "warning"); return; } const mainContentHtml = tab.contentEl.innerHTML; const encyclopediaHtml = getEncyclopediaHtml(tab.fullSearchResult.encyclopediaData.encyclopedia); const conceptTreeHtml = getConceptTreeHtml(tab.fullSearchResult.fastDeepDiveData.conceptTree); printContentArea.innerHTML = mainContentHtml + encyclopediaHtml + conceptTreeHtml; printContainer.style.display = 'block'; if (window.lucide) { printContainer.querySelectorAll('[data-lucide]').forEach(el => el.remove()); window.lucide.createIcons({ attr: 'data-lucide', element: printContainer }); } window.print(); setTimeout(() => { printContainer.style.display = 'none'; printContentArea.innerHTML = ''; }, 500); }

        // 9. File Storage (No changes needed)

        function createDownloadIcon(size = 'w-5 h-5') { return `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="${size} text-blue-600"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" x2="12" y1="15" y2="3"></line></svg>`; }
        window.downloadFile = function(fullPath) { getDownloadURL(ref(storage, fullPath)).then((url) => { const a = document.createElement('a'); a.href = url; a.target = '_blank'; a.click(); }).catch((error) => { console.error("Error getting download URL:", error); showToast("파일 다운로드 실패.", "error"); }); }
        window.deleteFile = function(docId, fullPath) { showConfirmationModal("정말로 이 파일을 삭제하시겠습니까?", async () => { const fileRef = ref(storage, fullPath); const docRef = doc(db, `artifacts/${appId}/users/${userId}/file_metadata/${docId}`); try { await deleteObject(fileRef); await deleteDoc(docRef); showToast("파일 삭제 성공.", "success"); } catch (error) { console.error("Error deleting file:", error); if (error.code === 'storage/object-not-found') { try { await deleteDoc(docRef); showToast("파일 정보 정리됨.", "info"); } catch (dbError) { console.error("Orphaned metadata delete error:", dbError); showToast("파일 삭제 실패.", "error"); } } else { showToast("파일 삭제 실패.", "error"); } } }); }

        // 10. Advanced AI Interactions (No changes needed)
        window.expandStory = async function(button, word, story, story_ko) { button.disabled = true; button.innerHTML = `<div class="loader w-5 h-5 border-2 border-t-blue-500 inline-block animate-spin"></div>`; try { const prompt = `You are a creative storyteller. Expand the following short, humorous story about the word "${word}" into a more detailed and engaging narrative of 3-4 paragraphs. Keep the funny and lighthearted tone.\n\nOriginal Story (English): "${story}"\nOriginal Story (Korean): "${story_ko}"\n\nPlease provide the expanded story in both English and Korean. Format your response as a JSON object with "expanded_story_en" and "expanded_story_ko" keys.`; const result = await callGemini(prompt, true); const episodeCard = button.closest('.card'); const storyContainer = episodeCard.querySelector('.space-y-2'); storyContainer.innerHTML = `<p class="text-lg leading-relaxed">${addClickToSearch(result.expanded_story_en)}</p><p class="text-md leading-relaxed text-gray-600 mt-2">${result.expanded_story_ko}</p>`; button.remove(); } catch (error) { console.error("Failed to expand story:", error); showToast("스토리 확장 실패.", "error"); button.disabled = false; button.innerHTML = `✨ 이야기 더 만들기`; } }
        window.craftSentences = async function(button, word) { const contextInput = button.parentElement.querySelector('#sentence-context-input'); const context = contextInput.value.trim(); if (!context) { showToast("상황을 입력해주세요.", "warning"); return; } const resultsContainer = button.parentElement.parentElement.querySelector('#sentence-crafter-results'); resultsContainer.innerHTML = `<div class="loader mx-auto"></div>`; button.disabled = true; try { const prompt = `Create 3 example English sentences using the word "${word}" in the context of "${context}". For each sentence, provide a Korean translation. Return the result as a JSON array like this: [{"en": "Sentence 1.", "ko": "번역 1."}, {"en": "Sentence 2.", "ko": "번역 2."}]`; const sentences = await callGemini(prompt, true); const sentencesHtml = sentences.map((s, i) => `<li class="flex items-start justify-between gap-3 mt-2"><div class="flex items-start"><span class="text-gray-500 mr-2">${i + 1}.</span><div><p class="text-md font-medium">${addClickToSearch(s.en)}</p><p class="text-sm text-gray-500">${s.ko}</p></div></div><div class="flex items-center flex-shrink-0 gap-1"><button class="icon-btn" onclick="speak('${s.en.replace(/'/g, "\\'")}', 'en-US')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">영어 듣기</span></button><button class="icon-btn" onclick="speak('${s.ko.replace(/'/g, "\\'")}', 'ko-KR')">${createVolumeIcon('w-5 h-5')}<span class="tooltip">한국어 듣기</span></button><button class="icon-btn" onclick="saveSentence('${s.en.replace(/'/g, "\\'")}', '${s.ko.replace(/'/g, "\\'")}')">${createSaveIcon('w-5 h-5')}<span class="tooltip">저장하기</span></button></div></li>`).join(''); resultsContainer.innerHTML = `<ul class="list-inside space-y-2">${sentencesHtml}</ul>`; safeCreateIcons(); } catch(error) { console.error("Failed to craft sentences:", error); resultsContainer.innerHTML = `<p class="text-red-500">문장 생성 실패.</p>`; showToast("문장 생성 실패.", "error"); } finally { button.disabled = false; } }

        // 11. Initializers and Event Listeners
        async function translateWordOnHover(word) {if (translationCache[word]) { return translationCache[word]; } try { const prompt = `Translate the English word "${word}" to Korean. Provide only the most common meaning.`; const translation = await callGemini(prompt); translationCache[word] = translation.trim(); return translationCache[word]; } catch (error) { console.error("Translation on hover failed:", error); return "번역 실패"; } }

        document.addEventListener('DOMContentLoaded', initializeFirebase);
    </script>
</body>
</html>
